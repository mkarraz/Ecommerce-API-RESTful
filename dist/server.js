(()=>{"use strict";var e={514:e=>{e.exports=require("knex")}},t={};function r(o){var n=t[o];if(void 0!==n)return n.exports;var i=t[o]={exports:{}};return e[o](i,i.exports,r),i.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var o in t)r.o(t,o)&&!r.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{const e=require("express");var t=r.n(e);const o=require("express-session");var n=r.n(o);const i=require("mongoose");var s=r.n(i);const c=require("bcrypt");var a=r.n(c),d=function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const u=new(s().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0}},{collection:"users"});u.pre("save",(function(e){return d(this,void 0,void 0,(function*(){const t=this;if(!t)return e();try{const r=yield a().genSalt(10),o=yield a().hash(t.password,r);t.password=o,e()}catch(t){e(t)}}))})),u.methods.comparePassword=(e,t)=>d(void 0,void 0,void 0,(function*(){return yield a().compareSync(e,t)}));const l=s().model("User",u),f=require("dotenv");var h=r.n(f);const p=require("path");var v=r.n(p);(0,f.config)({path:p.resolve(__dirname,"../../.env")});const m={admin:!0,hostNanme:"http://localhost:8080",PORT:process.argv[2]||parseInt(process.env.PORT)};h().config();const y={mongoDB:{URI:`mongodb+srv://${process.env.MONGOUSR}:${process.env.MONGOPWD}@${process.env.MONGOCLUSTER}.mongodb.net/?retryWrites=true&w=majority`}},g=require("connect-mongo");var w=r.n(g);const b=require("cluster");var P=r.n(b);const x=require("os");var I=r.n(x);const F=require("passport");var N=r.n(F);const $=require("passport-local");var j=function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const C=require("winston");var O=r.n(C);h().config();const B=process.env.ENVIRONMENT_MODE||"development";O().addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const M=O().format.combine(O().format.timestamp({format:"DD-MM-YYYY HH:mm:ss:ms"}),O().format.printf((e=>`${e.timestamp} ${e.level}: ${e.message}`))),R=[new(O().transports.Console)({format:O().format.combine(O().format.colorize({all:!0}),M)}),new(O().transports.File)({filename:"logs/warn.log",level:"warn",format:M}),new(O().transports.File)({filename:"logs/error.log",level:"error",format:M})],q=O().createLogger({level:"development"===B?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},transports:R});const E=(0,e.Router)();N().use("login",new $.Strategy({usernameField:"email",passwordField:"password"},((e,t,r)=>{return o=void 0,n=void 0,s=function*(){try{const o=yield l.findOne({email:e}).exec();return o?(yield o.comparePassword(t,o.password))?(q.info(o),r(null,o)):r(null,!1,{message:"Wrong password"}):r(null,!1,{message:"User doesn't exist"})}catch(e){r(e)}},new((i=void 0)||(i=Promise))((function(e,t){function r(e){try{a(s.next(e))}catch(e){t(e)}}function c(e){try{a(s.throw(e))}catch(e){t(e)}}function a(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(r,c)}a((s=s.apply(o,n||[])).next())}));var o,n,i,s}))),E.get("/",((e,t)=>{e.isAuthenticated()?t.redirect("/"):t.render("login")})),E.post("/",N().authenticate("login",{failureRedirect:"/login/failed",failureFlash:!0}),((e,t,r)=>j(void 0,void 0,void 0,(function*(){t.status(200).render("home",{user:e.user}),r()})))),E.get("/failed",((e,t)=>{t.status(401).render("failedLogin",{message:e.flash("error")[0]})}));const S=E,U=(0,e.Router)();U.post("/",((e,t)=>{e.session.destroy((()=>{t.render("login")}))}));const k=U;const D=(0,e.Router)();N().use("signup",new $.Strategy({usernameField:"email",passwordField:"password"},((e,t,r)=>{return o=void 0,n=void 0,s=function*(){const o=new l({email:e,password:t});try{return yield o.save(),r(null,o)}catch(e){return 11e3===e.code?r(null,!1,{message:"User already exists"}):(q.error(e),r(e))}},new((i=void 0)||(i=Promise))((function(e,t){function r(e){try{a(s.next(e))}catch(e){t(e)}}function c(e){try{a(s.throw(e))}catch(e){t(e)}}function a(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(r,c)}a((s=s.apply(o,n||[])).next())}));var o,n,i,s}))),D.get("/",((e,t)=>j(void 0,void 0,void 0,(function*(){e.isAuthenticated()?t.redirect("/"):t.render("signup")})))),D.post("/",N().authenticate("signup",{failureRedirect:"/signup/failed",failureFlash:!0}),((e,t,r)=>j(void 0,void 0,void 0,(function*(){t.status(201).render("createdUser",{user:e.user}),r()})))),D.get("/failed",((e,t)=>j(void 0,void 0,void 0,(function*(){t.status(409).render("failedSignup",{message:e.flash("error")[0]})}))));const T=D;__dirname;var _=function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const A=new class{constructor(e,t){this.db=r(514)(e),this.table=t,this.createTableIfNotExists()}createTableIfNotExists(){return _(this,void 0,void 0,(function*(){if(!(yield this.db.schema.hasTable(this.table)))try{yield this.db.schema.createTableIfNotExists(this.table,(e=>{e.increments("id").primary(),e.string("title"),e.integer("price"),e.string("thumbnail"),e.integer("timestamp")}))}catch(e){q.error(`Method: createTableIfNotExists, ${e}`)}}))}getAll(){return _(this,void 0,void 0,(function*(){return yield this.db.select("*").from(this.table)}))}getById(e){return _(this,void 0,void 0,(function*(){try{return(yield this.db.select("*").where("id",e).from(this.table))||{error:"Product not found"}}catch(e){q.error(`Method: getById, ${e}`)}return{error:"Fetch item method failed"}}))}addProduct(e){return _(this,void 0,void 0,(function*(){try{const t=Date.now();yield this.db.insert(Object.assign(Object.assign({},e),{timestamp:t})).into(this.table)}catch(e){q.error(`Method: addProduct, ${e}`)}}))}updateProductById(e,t){return _(this,void 0,void 0,(function*(){try{yield this.db.where("id",e).update({title:t.name,price:t.price,thumbnail:t.photoURL}).from(this.table)}catch(e){q.error(`Method: updateProductById, ${e}`)}}))}deleteProductById(e){return _(this,void 0,void 0,(function*(){try{yield this.db.delete("*").where("id",e).from(this.table)}catch(e){q.error(`Method: deleteProductById, ${e}`)}}))}}({client:"mysql",connection:{host:"127.0.0.1",port:3307,user:"root",password:"",database:"Clase_16"},pool:{min:0,max:7}},"products");var L=function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const J=require("@faker-js/faker");const z=(0,e.Router)();z.get("/products",((e,t)=>L(void 0,void 0,void 0,(function*(){const e=yield A.getAll();t.json(e)})))),z.get("/products/:id",((e,t)=>L(void 0,void 0,void 0,(function*(){const{id:r}=e.params,o=yield A.getById(Number(r));t.json(o)})))),z.post("/products",((e,t)=>L(void 0,void 0,void 0,(function*(){const r=e.body,o=yield A.addProduct(r);t.json(o)})))),z.put("/products/:id",((e,t)=>L(void 0,void 0,void 0,(function*(){const{id:r}=e.params,o=e.body;yield A.updateProductById(Number(r),o),t.json({msg:`Product ${r} updated.`})})))),z.delete("/products/:id",((e,t)=>L(void 0,void 0,void 0,(function*(){const{id:r}=e.params,o=yield A.deleteProductById(Number(r));t.json({deletedProduct:o})})))),z.get("/api/products-test",((e,t)=>{return r=void 0,o=void 0,i=function*(){try{const e=new class{constructor(){this.memoryProducts=[]}listFakerProducts(e=5){const t=[];for(let r=0;r<e;r++){const e={code:J.faker.random.word(),name:J.faker.commerce.productName(),price:Number(J.faker.commerce.price()),stock:Number(J.faker.random.numeric()),description:J.faker.commerce.productDescription(),photoURL:J.faker.image.imageUrl()};t.push(e)}return t}},r=yield e.listFakerProducts();return q.info("Result",r),t.json(r)}catch(e){q.error(`Han error has ocurred; ${e}`)}},new((n=void 0)||(n=Promise))((function(e,t){function s(e){try{a(i.next(e))}catch(e){t(e)}}function c(e){try{a(i.throw(e))}catch(e){t(e)}}function a(t){var r;t.done?e(t.value):(r=t.value,r instanceof n?r:new n((function(e){e(r)}))).then(s,c)}a((i=i.apply(r,o||[])).next())}));var r,o,n,i}));const Y=z,W=require("fs");var G=r.n(W),H=function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};class K{constructor(e){this.writeFile=e=>H(this,void 0,void 0,(function*(){try{yield G().promises.writeFile(K.filePath,JSON.stringify(e))}catch(e){q.error(`Method: writeFile, ${e}`)}})),this.readCartFile=()=>H(this,void 0,void 0,(function*(){try{return(yield G().promises.readFile(K.filePath,"utf8"))?JSON.parse(yield G().promises.readFile(K.filePath,"utf8")):[]}catch(e){if(-2===e.errno)try{return yield G().promises.writeFile(K.filePath,JSON.stringify([])),[]}catch(e){q.error(`Method: readFile: could not create file in such directory. ${e}`)}else q.error(`Method: readFile, ${e}`);return[]}})),this.readProductsFile=()=>H(this,void 0,void 0,(function*(){try{return(yield G().promises.readFile(this.productFilePath,"utf8"))?JSON.parse(yield G().promises.readFile(this.productFilePath,"utf8")):[]}catch(e){if(-2===e.errno)try{return yield G().promises.writeFile(this.productFilePath,JSON.stringify([])),[]}catch(e){q.error(`Could not create file in such directory. ${e}`)}else q.error(`Method: readFile, ${e}`);return[]}})),this.createNewCart=()=>H(this,void 0,void 0,(function*(){try{const e=yield this.readCartFile(),t=(new Date).toLocaleString("es-AR");if(0===e.length||void 0===e)return yield this.writeFile([{cartId:1,timestamp:t,products:[]}]),1;{const r=Math.max(...e.map((e=>e.cartId)))+1;return yield this.writeFile([...e,{cartId:r,timestamp:t,products:[]}]),r}}catch(e){return q.error(`Method: createNewCart, ${e}`),e}})),this.cartDeleteById=e=>H(this,void 0,void 0,(function*(){try{const t=yield this.readCartFile();if(0===t.length||void 0===t)return-1;{const r=t.filter((t=>t.cartId!==e));return r.length===t.length?-2:(yield this.writeFile(r),200)}}catch(e){return q.error(`Method: cartDeleteById, ${e}`),e}})),this.getProductsByCartId=e=>H(this,void 0,void 0,(function*(){try{const t=(yield this.readCartFile()).find((t=>t.cartId===e));if(void 0!==t){const e=t.products;return 0===e.length?new Error("Cart has no products."):e}return new Error("Cart not found")}catch(e){return q.error(`Method: getProductsByCartId, ${e}`),e}})),this.addToCartById=(e,t)=>H(this,void 0,void 0,(function*(){try{const r=Number(t.id),o=yield this.readCartFile(),n=o.find((t=>t.cartId===e)),i=(yield this.readProductsFile()).filter((e=>{if(e.id===r)return e}));if(0===i.length)return new Error(`There is no such product with id= ${r}`);if(void 0!==n&&void 0!==i){const t=[...n.products,...i],r=o.map((r=>r.cartId===e?Object.assign(Object.assign({},r),{products:t}):r));return yield this.writeFile(r),i}}catch(e){return q.error(`Method: addToCartById, ${e}`),e}})),this.deleteProductByCartId=(e,t)=>H(this,void 0,void 0,(function*(){try{const r=yield this.readCartFile(),o=r.find((t=>t.cartId===e));if(void 0===o)return new Error(`Cart id=${e} not found.`);{const n=o.products.filter((e=>e.id!==t));if(n.length===o.products.length)return new Error(`Product id=${t} not found in cart id=${e}.`);{const t=r.map((t=>t.cartId===e?Object.assign(Object.assign({},t),{products:n}):t));yield this.writeFile(t)}}}catch(e){return q.error(`Method: deleteProductByCartId, ${e}`),e}})),K.filePath=e,this.productFilePath="../../DB/products.txt"}}const V=new K("./api/data/cart.txt");var Q=function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const X=(0,e.Router)();X.post("/cart",((e,t)=>Q(void 0,void 0,void 0,(function*(){const e=yield V.createNewCart();if("number"!=typeof e)return t.status(500).json({error:-1,msg:"Error creating cart",cartId:e});t.json(e)})))),X.delete("/cart/:id",((e,t)=>Q(void 0,void 0,void 0,(function*(){const{id:r}=e.params,o=yield V.cartDeleteById(Number(r));return o instanceof Error?t.status(500).json({error:-1,msg:o.message}):-1===o?t.status(500).json({error:-1,msg:"Cart file is empty!"}):-2===o?t.status(500).json({error:-2,msg:`There is no cart with id= ${r}`}):void t.json(`Cart id: ${r} deleted.`)})))),X.get("/cart/:id/products",((e,t)=>Q(void 0,void 0,void 0,(function*(){const{id:r}=e.params,o=yield V.getProductsByCartId(Number(r));if(o instanceof Error)return t.status(500).json({error:-1,msg:o.message});t.json(o)})))),X.post("/cart/:id/products",((e,t)=>Q(void 0,void 0,void 0,(function*(){const{id:r}=e.params,o=e.body,n=yield V.addToCartById(Number(r),o);if(n instanceof Error)return t.status(500).json({error:-1,msg:n.message});t.json(n)})))),X.delete("/cart/:id/products/:id_prod",((e,t)=>Q(void 0,void 0,void 0,(function*(){const{id:r,id_prod:o}=e.params,n=yield V.deleteProductByCartId(Number(r),Number(o));if(n instanceof Error)return t.status(500).json({error:-1,msg:n.message});t.json(n)}))));const Z=X,ee=require("child_process"),te=(0,e.Router)();te.get("/",((e,t)=>{const{amount:r}=e.query;let o=Number(r);o||(o=1e8);const n=(0,ee.fork)("./api/utils/getRandomNumbers.js");n.send(o),n.on("message",(e=>{t.end(JSON.stringify(e,null,3))})),n.on("exit",(e=>{q.info("Se ha cerrado el proceso",e)}))}));const re=te,oe=(0,e.Router)();oe.get("/",((e,t)=>{const r={numberOfProcessors:I().cpus().length,title:process.argv,arguments:process.argv,system:process.platform,version:process.version,memory:process.memoryUsage.rss(),path:process.execPath,id:process.pid,folder:process.cwd()};return console.log(r),t.render("info",r)}));const ne=oe,ie=require("connect-flash");var se=r.n(ie);const ce=require("cookie-parser");var ae=r.n(ce);const de=require("compression");var ue=r.n(de),le=function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};q.info("Información"),q.debug("Debug"),q.warn("Advertencia"),q.error("Error");const fe=m.PORT||8081,he=t()();if("CLUSTER"===process.argv[3]&&P().isPrimary){const e=I().cpus().length;q.info(`Number of CPUs: ${e}`),q.info(`Master PID ${process.pid} is running`);for(let t=0;t<e;t++)P().fork();P().on("exit",((e,t,r)=>{q.info(`Worker ${e.process.pid} died`),P().fork()}))}else he.use("/api/randoms",re),he.listen(fe,(()=>{q.info(`Server listening on port ${fe}.`,`Process ID: ${process.pid}.`)})).on("error",(e=>q.error(`An error has ocurred when starting: ${e}`)));he.use(t().static(v().join(__dirname,"../public"))),he.use(t().json()),he.use(ae()()),he.use(t().urlencoded({extended:!0})),he.set("views",v().join(__dirname,"../api/views")),he.set("view engine","ejs");const pe={useNewUrlParser:!0,useUnifiedTopology:!0};he.use(n()({store:w().create({mongoUrl:y.mongoDB.URI,mongoOptions:pe}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),s().connect(y.mongoDB.URI,pe,(e=>{try{q.info("Connected to MongoDB Atlas")}catch(e){q.error(`${e}`)}})),he.use(N().initialize()),he.use(N().session()),he.use(se()()),N().serializeUser(((e,t)=>{t(null,e._id)})),N().deserializeUser(((e,t)=>le(void 0,void 0,void 0,(function*(){const r=yield l.findById(e);t(null,r)})))),he.use("/login",S),he.use("/logout",k),he.use("/signup",T),he.use("/api",Y,Z),he.get("/",((e,t)=>le(void 0,void 0,void 0,(function*(){t.render("home",{logged:!0,user:e.user})})))),he.use("/info",ne),he.use("/infoCompressed",ue()(),ne)})()})();