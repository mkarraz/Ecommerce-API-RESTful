(()=>{"use strict";var e,t={25:(e,t,r)=>{r.d(t,{Z:()=>o});var n=r(142);r.n(n)().config();const o={mongoDB:{URI:`mongodb+srv://${process.env.MONGOUSR}:${process.env.MONGOPWD}@${process.env.MONGOCLUSTER}.mongodb.net/?retryWrites=true&w=majority`}}},847:(e,t,r)=>{r.d(t,{Z:()=>d});var n=r(185),o=r.n(n),i=r(25);const d=class{constructor(e){this.model=e,this.connect()}connect(){return e=this,t=void 0,n=function*(){try{yield o().connect(i.Z.mongoDB.URI),console.log("Connected to mongoDB Atlas!")}catch(e){console.log(e)}},new((r=void 0)||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}));var e,t,r,n}}},965:(e,t,r)=>{r.r(t),r.d(t,{default:()=>l});var n=r(847),o=r(185),i=r.n(o);const d=new(i().Schema)({products:[{type:Object,required:!0,ref:"products"}],user:{type:String,required:!0},timestamp:{type:Number,required:!0,default:Date.now}}),s=i().model("carts",d);var c=r(826),u=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};class a extends n.Z{constructor(){super(s)}createNewCart(e){return u(this,void 0,void 0,(function*(){const t=new this.model({user:e.id,products:[]});yield t.save()}))}cartProdDeleteById(e){return u(this,void 0,void 0,(function*(){const t=yield this.model.findOne({user:e.id});if(null===t)return{error:"Cart not found in cartProdDeleteById method"};0===(yield this.model.updateOne({_id:t._id},{$set:{products:[]}})).modifiedCount?c.Z.error("Products not deleted from cart"):c.Z.info("Products deleted from cart")}))}addToCartById(e,t){return u(this,void 0,void 0,(function*(){const r=yield this.model.findOne({user:e._id});if(null===r)c.Z.error("Cart not found in addToCartById method.");else{if(0!==(yield this.model.updateOne({_id:r._id},{$push:{products:t}})).modifiedCount)return c.Z.info("Product succesfully added to cart!"),r;c.Z.error("Product not added to cart.")}}))}getProductsByCartId(e){return u(this,void 0,void 0,(function*(){const t=yield this.model.findOne({user:e.id});if(null===t)return{error:"Cart not found"};{const e=t.products;return c.Z.info(`Cart: ${e}`),e}}))}deleteProductByCartId(e,t){return u(this,void 0,void 0,(function*(){c.Z.info(`prod: ${t}`);const r=yield this.model.findOne({user:e.id});if(c.Z.info(`cart: ${r}`),null===r)return{error:"Cart not found"};0===(yield this.model.updateOne({_id:r._id},{$pull:{products:{id:t.id}}})).modifiedCount?c.Z.error("Product not deleted from cart"):c.Z.info("Product succesfully deleted from cart!")}))}}const l=new a},112:(e,t,r)=>{r.r(t),r.d(t,{default:()=>a});var n=r(847),o=r(185),i=r.n(o);const d=new(i().Schema)({name:{type:String,required:!0,minlength:1,maxlength:50},price:{type:Number,required:!0,min:0},description:{type:String,required:!0,minlength:1,maxlength:200},photoURL:{type:String,required:!0,minlength:1,maxlength:200},stock:{type:Number,required:!0,min:0},timestamp:{type:Number,required:!1,default:Date.now}}),s=i().model("products",d);var c=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};class u extends n.Z{constructor(){super(s)}getAll(){return c(this,void 0,void 0,(function*(){try{return yield this.model.find({})}catch(e){console.log("Method getAll: ",e)}}))}getById(e){return c(this,void 0,void 0,(function*(){try{const t=yield this.model.findOne({_id:e},{__v:0});return null===t?{error:"Product not found"}:t}catch(e){console.log("Method getById: ",e)}}))}addProduct(e){return c(this,void 0,void 0,(function*(){try{const t=new this.model(e);return yield t.save()}catch(e){console.log("Method add: ",e)}}))}updateProductById(e,t){return c(this,void 0,void 0,(function*(){try{return 0===(yield this.model.updateOne({_id:e},t)).matchedCount?{error:"Product not found."}:{msg:`Product id: ${e} updated!`}}catch(e){console.log("Method update: ",e)}}))}deleteProductById(e){return c(this,void 0,void 0,(function*(){try{return 0===(yield this.model.deleteOne({_id:e})).deletedCount?{error:"Product not found."}:{msg:`Product id: ${e} deleted!`}}catch(e){console.log("Method deleteById: ",e)}}))}}const a=new u},826:(e,t,r)=>{r.d(t,{Z:()=>u});const n=require("winston");var o=r.n(n),i=r(142);r.n(i)().config();const d=process.env.ENVIRONMENT_MODE||"development";o().addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const s=o().format.combine(o().format.timestamp({format:"DD-MM-YYYY HH:mm:ss:ms"}),o().format.printf((e=>`${e.timestamp} ${e.level}: ${e.message}`))),c=[new(o().transports.Console)({format:o().format.combine(o().format.colorize({all:!0}),s)}),new(o().transports.File)({filename:"logs/warn.log",level:"warn",format:s}),new(o().transports.File)({filename:"logs/error.log",level:"error",format:s})],u=o().createLogger({level:"development"===d?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},transports:c})},142:e=>{e.exports=require("dotenv")},185:e=>{e.exports=require("mongoose")},147:e=>{e.exports=require("fs")}},r={};function n(e){var o=r[e];if(void 0!==o)return o.exports;var i=r[e]={exports:{}};return t[e](i,i.exports,n),i.exports}n.m=t,n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,r)=>(n.f[r](e,t),t)),[])),n.u=e=>e+".server.js",n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},e={179:1},n.f.require=(t,r)=>{e[t]||(t=>{var r=t.modules,o=t.ids,i=t.runtime;for(var d in r)n.o(r,d)&&(n.m[d]=r[d]);i&&i(n);for(var s=0;s<o.length;s++)e[o[s]]=1})(require("./"+n.u(t)))},(()=>{const e=require("express");var t=n.n(e);const r=require("express-session");var o=n.n(r),i=n(25);const d=require("connect-mongo");var s=n.n(d),c=n(142),u=n.n(c);let a,l;switch(u().config(),process.env.DB_PROVIDER){case"fs":n.e(197).then(n.bind(n,197)).then((e=>a=e.default)),n.e(287).then(n.bind(n,287)).then((e=>l=e.default));break;case"mongodb":Promise.resolve().then(n.bind(n,112)).then((e=>a=e.default)),Promise.resolve().then(n.bind(n,965)).then((e=>l=e.default));break;default:a=n(112),l=n(965)}var f=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};var v=n(826),h=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const p=(e,t)=>h(void 0,void 0,void 0,(function*(){v.Z.info(`${e.method} request to '${e.originalUrl}' route: Getting all products from DB`);try{return yield f(void 0,void 0,void 0,(function*(){return yield a.getAll()}))}catch(e){v.Z.error(`Error in getAll method: ${e}`)}})),m=require("nodemailer");var y=n.n(m),g=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};u().config();const w=y().createTransport({service:"gmail",auth:{user:process.env.GMAIL_MAIL,pass:process.env.GMAIL_PROVISIONAL_PASS}}),$=new class{constructor(){this.transporter=w}newRegister(e){return g(this,void 0,void 0,(function*(){try{yield this.transporter.sendMail({from:"E-commerce MK",to:process.env.GMAIL_MAIL,subject:"New registered user",html:` \n                        <h1>A new user has been registered!</h1>\n                        <br>\n                        <p>Name: ${e.name}</p> \n                        <p>eMail: ${e.email}</p>\n                        <p>Address: ${e.address}</p>   \n                        <p>Age: ${e.age}</p>\n                        <p>Phone Number: ${e.phoneNumber}</p>`})}catch(t){v.Z.error(`An error has occurred when sending the user registration email: ${e.email}`)}}))}newOrder(e,t){return g(this,void 0,void 0,(function*(){try{yield this.transporter.sendMail({from:"E-commerce MK",to:process.env.GMAIL_MAIL,subject:`New order from ${e.name}`,html:`\n                    <h5> User: </h5>\n                        <p>${e.name}</p> \n                        <p>${e.email}</p> \n                        <p>${e.phoneNumber}</p>\n                        </hr>\n            \n                        <h2> Pedido </h2>\n                        <table>\n                            <thead>\n                                <tr>\n                                    <th scope="col">Name</th>\n                                    <th scope="col">Price</th>\n                                    <th scope="col">Description</th>\n                                    <th scope="col">Thumbnail</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                ${t.map((e=>`<tr>\n                                    <td>${e.name}</td>\n                                    <td>${e.price}</td>\n                                    <td>${e.description}</td>\n                                    <td><img style="max-width: 40px" src="${e.photoURL}"></img></td>\n                                </tr>`))}\n                            </tbody>\n                        </table>\n                        `})}catch(t){v.Z.error(`An error has occurred when sending the user registration email: ${e.email}`)}}))}},P=require("twilio");var b=n.n(P),I=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};u().config();const Z=process.env.TWILIO_ACCOUNTSID,x=process.env.TWILIO_AUTH_TOKEN,q=b()(Z,x),S=new class{newSMS(e){return I(this,void 0,void 0,(function*(){try{yield q.messages.create({body:"Your order has been received and is being process",from:process.env.TWILIO_NUMBER,to:e.phoneNumber})}catch(t){v.Z.error(`An error has occurred when sending SMS: ${e.email}`)}}))}newWhatsapp(e){return I(this,void 0,void 0,(function*(){try{yield q.messages.create({body:`New order from ${e.name} - ${e.email}`,from:`whatsapp:${process.env.TWILIO_WHATSAPP}`,to:`whatsapp:${process.env.TWILIO_ADMIN_NUMBER}`})}catch(e){v.Z.error("An error has occurred when sending a Whatsapp message")}}))}};var A=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const O=e=>A(void 0,void 0,void 0,(function*(){return yield l.getProductsByCartId(e)}));var B=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const C=(e,t)=>B(void 0,void 0,void 0,(function*(){try{yield(e=>A(void 0,void 0,void 0,(function*(){return yield l.createNewCart(e)})))(t),v.Z.info(`Cart created for user ${t.email}`)}catch(e){v.Z.error(e)}}));var N=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const _=(0,e.Router)();_.route("/").get(p).post(((e,t)=>h(void 0,void 0,void 0,(function*(){v.Z.info(`${e.method} request to '${e.originalUrl}' route: Adding new product to DB`);try{const r=e.body;yield(e=>f(void 0,void 0,void 0,(function*(){return yield a.addProduct(e)})))(r),t.redirect("/")}catch(e){v.Z.error(`Error in addProduct method: ${e}`)}})))),_.route("/:id").get(((e,t)=>h(void 0,void 0,void 0,(function*(){v.Z.info(`${e.method} request to '${e.originalUrl}' route: Getting product by id from DB`);try{const{id:r}=e.params,n=yield(e=>f(void 0,void 0,void 0,(function*(){return yield a.getById(Number(e))})))(r);t.json(n)}catch(e){v.Z.error(`Error in getById method: ${e}`)}})))).put(((e,t)=>h(void 0,void 0,void 0,(function*(){v.Z.info(`${e.method} request to '${e.originalUrl}' route: Updating product at DB`);try{const{id:r}=e.params,n=e.body;yield((e,t)=>f(void 0,void 0,void 0,(function*(){return yield a.updateProductById(Number(e),t)})))(r,n),t.json({msg:`Product ${r} updated.`})}catch(e){v.Z.error(`Error in updateProductById method: ${e}`)}})))).delete(((e,t)=>h(void 0,void 0,void 0,(function*(){v.Z.info(`${e.method} request to '${e.originalUrl}' route: Deleting product by id from DB`);try{const{id:r}=e.params,n=yield(e=>f(void 0,void 0,void 0,(function*(){return yield a.deleteProductById(Number(e))})))(r);t.json({deletedProduct:n})}catch(e){v.Z.error(`Error in deleteProductById method: ${e}`)}}))));const U=_,M=(0,e.Router)();M.route("/").post(C).get(((e,t)=>B(void 0,void 0,void 0,(function*(){v.Z.info(`${e.method} request to '${e.originalUrl}' route: Getting products by Cart ID.`);try{const r=e.user,n=yield O(r);t.render("cart",{products:n,user:r})}catch(e){v.Z.error(`Error in getProductsByCartId method: ${e}`)}})))),M.route("/delete").post(((e,t)=>B(void 0,void 0,void 0,(function*(){try{const r=e.user;yield(e=>A(void 0,void 0,void 0,(function*(){return yield l.cartProdDeleteById(e)})))(r),t.redirect("/api/cart")}catch(e){v.Z.error(`Error in cartProdDeleteById method: ${e}`)}})))),M.route("/addProduct").post(((e,t)=>B(void 0,void 0,void 0,(function*(){try{const r=e.user,n=e.body;yield((e,t)=>A(void 0,void 0,void 0,(function*(){return yield l.addToCartById(e,t)})))(r,n),t.redirect("/api/cart")}catch(e){v.Z.error(`Error in addToCartById method: ${e}`)}})))),M.route("/deleteProduct").post(((e,t)=>B(void 0,void 0,void 0,(function*(){try{const r=e.user,n=e.body;yield((e,t)=>A(void 0,void 0,void 0,(function*(){return v.Z.info(`Service: ${t}`),yield l.deleteProductByCartId(e,t)})))(r,n),t.redirect("/api/cart")}catch(e){v.Z.error(`Error in deleteProductByCartId method: ${e}`)}})))),M.route("/order").post(((e,t)=>B(void 0,void 0,void 0,(function*(){try{const r=e.user,n=yield O(r);$.newOrder(r,n),S.newSMS(r),S.newWhatsapp(r),t.redirect("/")}catch(e){v.Z.error(`Error in getProductsByCartId method: ${e}`)}}))));const E=M,D=(e,t,r)=>{try{return e.isAuthenticated()?r():t.render("unauthorized")}catch(e){v.Z.error(`Error has occured when checkUserAuth method, ${e}`)}};const R=(0,e.Router)();R.get("/",D,((e,t)=>{return r=void 0,n=void 0,i=function*(){const r=yield p(e);t.render("home",{logged:!0,user:e.user,products:r})},new((o=void 0)||(o=Promise))((function(e,t){function d(e){try{c(i.next(e))}catch(e){t(e)}}function s(e){try{c(i.throw(e))}catch(e){t(e)}}function c(t){var r;t.done?e(t.value):(r=t.value,r instanceof o?r:new o((function(e){e(r)}))).then(d,s)}c((i=i.apply(r,n||[])).next())}));var r,n,o,i})),R.route("/addProdForm").get(((e,t,r)=>{const n=e.user;try{return"true"===n.isAdmin?r():t.json({error:"No tiene Permiso",descripcion:`You do not have permission to access to ${e.originalUrl}`,code:"403"})}catch(e){v.Z.error(`Error has occured when checkUserAuth method, ${e}`)}}),((e,t)=>N(void 0,void 0,void 0,(function*(){v.Z.info(`${e.method} request to '${e.originalUrl}' route: Rendering add product form page.`);try{const r=e.user;t.status(200).render("products/addProdForm",{user:r})}catch(e){v.Z.error(e)}}))));const T=R,L=require("passport");var j=n.n(L);const k=(0,e.Router)();k.get("/",((e,t)=>{e.isAuthenticated()?t.redirect("/"):t.render("login")})),k.post("/",j().authenticate("login",{failureRedirect:"/login/failed",failureFlash:!0}),((e,t,r)=>N(void 0,void 0,void 0,(function*(){try{e.isAuthenticated()&&r()}catch(e){v.Z.error(`Error when login method in SessionControllers, ${e}`)}})))),k.get("/failed",((e,t)=>{t.status(401).render("failedLogin",{message:e.flash("error")[0]})}));const W=(0,e.Router)();W.post("/",((e,t)=>{if(e.isAuthenticated()){const r=e.user;e.session.destroy((()=>{t.render("logout",{user:r})}))}else t.redirect("/")}));var G=n(185),F=n.n(G);const Y=require("bcrypt");var z=n.n(Y),H=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const K=new(F().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0},name:{type:String,required:!0},address:{type:String,required:!0},age:{type:Number,required:!0},phoneNumber:{type:String,required:!0},picture:{type:String,required:!0},isAdmin:{type:String,required:!0}},{collection:"users"});K.pre("save",(function(e){return H(this,void 0,void 0,(function*(){const t=this;if(!t)return e();try{const r=yield z().genSalt(10),n=yield z().hash(t.password,r);t.password=n,e()}catch(t){e(t)}}))})),K.post("save",(function(e){return H(this,void 0,void 0,(function*(){try{const e={id:this.id,email:this.email};yield C(0,e)}catch(e){v.Z.error(`Error trying to update user cartId: ${e}`)}}))})),K.methods.comparePassword=(e,t)=>H(void 0,void 0,void 0,(function*(){return yield z().compareSync(e,t)}));const V=F().model("User",K),J=require("multer");var Q=n.n(J);const X=Q().diskStorage({destination:function(e,t,r){r(null,"uploads")},filename:function(e,t,r){r(null,`${Date.now()}-${t.originalname}`)}}),ee=Q()({storage:X});const te=(0,e.Router)();te.get("/",((e,t)=>N(void 0,void 0,void 0,(function*(){e.isAuthenticated()?t.redirect("/"):t.render("signup")})))),te.post("/",j().authenticate("signup",{failureRedirect:"/signup/failed",failureFlash:!0}),((e,t,r)=>N(void 0,void 0,void 0,(function*(){const r=e.user;t.status(201).render("createdUser",{user:r}),$.newRegister(r)})))),te.get("/upload",((e,t)=>{e.isAuthenticated()?t.render("upload"):t.render("login")})),te.post("/upload",ee.single("picture"),((e,t,r)=>{return n=void 0,o=void 0,d=function*(){const t=e.file;if(!t)return r({message:"Error when uploading file.",statusCode:400});const n={email:e.user.email,password:e.user.password,name:e.user.name,address:e.user.address,age:e.user.age,phoneNumber:e.user.phoneNumber,picture:`${t.filename}`,isAdmin:e.user.isAdmin};try{if(0===(yield V.updateOne({_id:e.user.id},n)).matchedCount)return r({message:"User not found",statusCode:400})}catch(e){v.Z.error(`Error trying to update users avatar: ${e}`)}r()},new((i=void 0)||(i=Promise))((function(e,t){function r(e){try{c(d.next(e))}catch(e){t(e)}}function s(e){try{c(d.throw(e))}catch(e){t(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,s)}c((d=d.apply(n,o||[])).next())}));var n,o,i,d}),((e,t,r)=>N(void 0,void 0,void 0,(function*(){t.status(201).render("uploadSuccess"),r()})))),te.get("/failed",((e,t)=>N(void 0,void 0,void 0,(function*(){t.status(409).render("failedSignup",{message:e.flash("error")[0]})}))));const re=(0,e.Router)();re.use("/login",k),re.use("/logout",W),re.use("/signup",te),re.use("/views",T),re.use("/api/products",U),re.use("/api/cart",E),re.use("/",D,((e,t)=>{return r=void 0,n=void 0,i=function*(){return t.redirect("/views")},new((o=void 0)||(o=Promise))((function(e,t){function d(e){try{c(i.next(e))}catch(e){t(e)}}function s(e){try{c(i.throw(e))}catch(e){t(e)}}function c(t){var r;t.done?e(t.value):(r=t.value,r instanceof o?r:new o((function(e){e(r)}))).then(d,s)}c((i=i.apply(r,n||[])).next())}));var r,n,o,i}));const ne=re,oe=require("cluster");var ie=n.n(oe);const de=require("os");var se=n.n(de);const ce=require("connect-flash");var ue=n.n(ce);const ae=require("cookie-parser");var le=n.n(ae);const fe=require("passport-local");var ve=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const he=require("path");var pe=n.n(he);const me=process.env.PORT||8081,ye=t()();if("CLUSTER"===process.argv[3]&&ie().isPrimary){const e=se().cpus().length;v.Z.info(`Number of CPUs: ${e}`),v.Z.info(`Master PID ${process.pid} is running`);for(let t=0;t<e;t++)ie().fork();ie().on("exit",((e,t,r)=>{v.Z.info(`Worker ${e.process.pid} died`),ie().fork()}))}else ye.listen(me,(()=>{v.Z.info(`Server listening on port ${me}.`,`Process ID: ${process.pid}.`)})).on("error",(e=>v.Z.error(`An error has ocurred when starting: ${e}`)));ye.use(t().static(pe().join(__dirname,"../uploads"))),ye.use(t().json()),ye.use(le()()),ye.use(t().urlencoded({extended:!0})),ye.set("views",pe().join(__dirname,"../api/views")),ye.set("view engine","ejs"),ye.use(o()({store:s().create({mongoUrl:i.Z.mongoDB.URI,mongoOptions:{useNewUrlParser:!0,useUnifiedTopology:!0}}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),ye.use(j().initialize()),ye.use(j().session()),ye.use(ue()()),function(e){e.use("login",new fe.Strategy({usernameField:"email",passwordField:"password"},((e,t,r)=>ve(this,void 0,void 0,(function*(){try{const n=yield V.findOne({email:e}).exec();return n?(yield n.comparePassword(t,n.password))?(v.Z.info(n),r(null,n)):r(null,!1,{message:"Wrong password"}):r(null,!1,{message:"User doesn't exist"})}catch(e){r(e)}}))))),e.use("signup",new fe.Strategy({passReqToCallback:!0,usernameField:"email"},((e,t,r,n)=>ve(this,void 0,void 0,(function*(){const o=new V({email:t,password:r,name:e.body.name,address:e.body.address,age:e.body.age,phoneNumber:`+54${e.body.phoneNumber}`,picture:"avatar.png",isAdmin:"false",cartId:"empty"});try{return yield o.save(),n(null,o)}catch(e){return 11e3===e.code?n(null,!1,{message:"User already exists"}):(v.Z.error(e),n(e))}}))))),e.serializeUser(((e,t)=>{t(null,e._id)})),e.deserializeUser(((e,t)=>ve(this,void 0,void 0,(function*(){const r=yield V.findById(e);t(null,r)}))))}(j()),ye.use("/",ne)})()})();