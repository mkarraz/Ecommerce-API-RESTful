(()=>{"use strict";var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=require("express");var r=t.n(e);const n=require("express-session");var o=t.n(n);const i=require("dotenv");var s=t.n(i);s().config();const d={PERSISTENCE:process.argv[4]||process.env.PERSISTENCE||1,PORT:process.env.PORT||8081,ENVIRONMENT_MODE:process.env.ENVIRONMENT_MODE,MONGO_ATLAS_URL:process.env.MONGO_ATLAS_URL,MONGO_OPTIONS:{useNewUrlParser:!0,useUnifiedTopology:!0},SECRET_KEY:process.env.SECRET_KEY,SESSION_TIME:process.env.SESSION_TIME,TWILIO_ACCOUNTSID:process.env.TWILIO_ACCOUNTSID,TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN,TWILIO_NUMBER:process.env.TWILIO_NUMBER,TWILIO_ADMIN_NUMBER:process.env.TWILIO_ADMIN_NUMBER,TWILIO_WHATSAPP:process.env.TWILIO_WHATSAPP,GMAIL_MAIL:process.env.GMAIL_MAIL,GMAIL_PROVISIONAL_PASS:process.env.GMAIL_PROVISIONAL_PASS},a=require("connect-mongo");var c=t.n(a);const u=require("cluster");var h=t.n(u);const l=require("os");var f=t.n(l);const p=require("socket.io"),m=require("mongoose");var y=t.n(m);const v=new(y().Schema)({name:{type:String,required:!0,minlength:1,maxlength:50},price:{type:Number,required:!0,min:0},description:{type:String,required:!0,minlength:1,maxlength:200},photoURL:{type:String,required:!0,minlength:1,maxlength:200},stock:{type:Number,required:!0,min:0},category:{type:String,required:!0,min:0},timestamp:{type:String,required:!1,default:(new Date).toLocaleString()}}),w=y().model("products",v);var g=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const I=require("winston");var P=t.n(I);s().config();const C=process.env.ENVIRONMENT_MODE||"development";P().addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const O=P().format.combine(P().format.timestamp({format:"DD-MM-YYYY HH:mm:ss:ms"}),P().format.printf((t=>`${t.timestamp} ${t.level}: ${t.message}`))),E=[new(P().transports.Console)({format:P().format.combine(P().format.colorize({all:!0}),O)}),new(P().transports.File)({filename:"logs/warn.log",level:"warn",format:O}),new(P().transports.File)({filename:"logs/error.log",level:"error",format:O})],M=P().createLogger({level:"development"===C?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},transports:E});const T=()=>{return t=void 0,e=void 0,n=function*(){try{yield y().connect(`${d.MONGO_ATLAS_URL}`),M.info("Connected to mongoDB Atlas!")}catch(t){M.error(t)}},new((r=void 0)||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}));var t,e,r,n};var $,S,B,A,_,b,x,N,q=function(t,e,r,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?o.call(t,r):o?o.value=r:e.set(t,r),r},U=function(t,e,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(t):n?n.value:e.get(t)};$=new WeakMap,S=new WeakMap,B=new WeakMap,A=new WeakMap,_=new WeakMap,b=new WeakMap,x=new WeakMap,N=new WeakMap;var L=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const D=y().Types.ObjectId;class j extends class{constructor(){}getById(t){return g(this,void 0,void 0,(function*(){throw new Error("Product - getById not Implemented")}))}getAll(){return g(this,void 0,void 0,(function*(){throw new Error("Product - getAll not Implemented")}))}addProduct(t){return g(this,void 0,void 0,(function*(){throw new Error("Product - addProduct not Implemented")}))}updateProductById(t,e){return g(this,void 0,void 0,(function*(){throw new Error("Product - updateProductById not Implemented")}))}deleteProductById(t){return g(this,void 0,void 0,(function*(){throw new Error("Product - deleteProductById not Implemented")}))}}{constructor(t,e){super(),this.model=t,this.DTO=e,T()}static getInstance(t,e){return this.instance||(this.instance=new j(t,e)),this.instance}getAll(){return L(this,void 0,void 0,(function*(){try{return(yield this.model.find()).map((t=>new this.DTO(t).toJson()))}catch(t){M.error(`MongoAtlas getAll method error: ${t}`)}}))}getById(t){return L(this,void 0,void 0,(function*(){try{if(!D.isValid(t))return;const e=yield this.model.findById(t);return e?new this.DTO(e).toJson():null}catch(t){M.error(`MongoAtlas getById method error: ${t}`)}}))}getByCategory(t){return L(this,void 0,void 0,(function*(){try{const e=yield this.model.find({category:{$in:`${t}`}});return e?e.map((t=>new this.DTO(t).toJson())):null}catch(t){M.error(`MongoAtlas getById method error: ${t}`)}}))}addProduct(t){return L(this,void 0,void 0,(function*(){try{const e=new this.model(t),r=yield e.save();return new this.DTO(r).toJson()}catch(t){M.error(`MongoAtlas addProduct method error: ${t}`)}}))}updateProductById(t,e){return L(this,void 0,void 0,(function*(){try{return 0===(yield this.model.updateOne({_id:t},e)).matchedCount?{error:"Product not found."}:this.getById(t)}catch(t){M.error(`MongoAtlas updateProductById method error: ${t}`)}}))}deleteProductById(t){return L(this,void 0,void 0,(function*(){try{const e=yield this.getById(t);if(!e)return;return yield this.model.deleteOne({_id:t}),e}catch(t){M.error(`MongoAtlas deleteProductById method error: ${t}`)}}))}}const R=j.getInstance(w,class{constructor(t){$.set(this,void 0),S.set(this,void 0),B.set(this,void 0),A.set(this,void 0),_.set(this,void 0),b.set(this,void 0),x.set(this,void 0),N.set(this,void 0),q(this,$,t._id,"f"),q(this,S,t.name,"f"),q(this,B,t.price,"f"),q(this,A,t.description,"f"),q(this,_,t.photoURL,"f"),q(this,b,t.stock,"f"),q(this,x,t.category,"f"),q(this,N,t.timestamp,"f")}getId(){return U(this,$,"f")}getName(){return U(this,S,"f")}getPrice(){return U(this,B,"f")}getDescription(){return U(this,A,"f")}getPhotoURL(){return U(this,_,"f")}getStock(){return U(this,b,"f")}getTimestamp(){return U(this,N,"f")}toJson(){return{id:U(this,$,"f"),name:U(this,S,"f"),price:U(this,B,"f"),description:U(this,A,"f"),photoURL:U(this,_,"f"),stock:U(this,b,"f"),category:U(this,x,"f"),timestamp:U(this,N,"f")}}}),W=new(y().Schema)({products:[{productId:{type:String,required:!0},name:{type:String,required:!0},quantity:{type:Number},description:{type:String,required:!0},price:{type:String,required:!0},photoURL:{type:String,required:!0},_id:!1}],userId:{type:String,required:!0},userEmail:{type:String,required:!0},timestamp:{type:String,required:!0,default:(new Date).toLocaleString()}}),k=y().model("carts",W);var G=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};var F,J,H,Y,K,V=function(t,e,r,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?o.call(t,r):o?o.value=r:e.set(t,r),r},z=function(t,e,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(t):n?n.value:e.get(t)};F=new WeakMap,J=new WeakMap,H=new WeakMap,Y=new WeakMap,K=new WeakMap;const Q=class{constructor(t){F.set(this,void 0),J.set(this,void 0),H.set(this,void 0),Y.set(this,void 0),K.set(this,void 0),V(this,F,t.id,"f"),V(this,J,t.products,"f"),V(this,H,t.userId,"f"),V(this,Y,t.userEmail,"f"),V(this,K,t.timestamp,"f")}getId(){return{products:z(this,F,"f")}}getProducts(){return{products:z(this,J,"f")}}getUserId(){return{products:z(this,H,"f")}}getTimestamp(){return{products:z(this,K,"f")}}toJson(){return{id:z(this,F,"f"),products:z(this,J,"f"),userId:z(this,H,"f"),userEmail:z(this,Y,"f"),timestamp:z(this,K,"f")}}};var X=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};class Z extends class{constructor(){}createNewCart(t){return G(this,void 0,void 0,(function*(){throw new Error("Cart - createNewCart not Implemented")}))}cartProdDeleteById(t){return G(this,void 0,void 0,(function*(){throw new Error("Cart - cartProdDeleteById not Implemented")}))}addToCartById(t,e,r){return G(this,void 0,void 0,(function*(){throw new Error("Cart - addToCartById not Implemented")}))}getProductsByCartId(t){return G(this,void 0,void 0,(function*(){throw new Error("Cart - getProductsByCartId not Implemented")}))}deleteProductByCartId(t,e){return G(this,void 0,void 0,(function*(){throw new Error("Cart - deleteProductByCartId not Implemented")}))}}{constructor(t,e){super(),this.model=t,this.DTO=e,T()}static getInstance(t,e){return this.instance||(this.instance=new Z(t,e)),this.instance}createNewCart(t){return X(this,void 0,void 0,(function*(){const e=new this.model({userId:t.id,userEmail:t.email,products:[]}),r=yield e.save();return new this.DTO(r).toJson()}))}deleteCartProducts(t){return X(this,void 0,void 0,(function*(){const e=yield this.model.findOne({userId:t.id});if(null===e)return{error:"Cart not found in cartProdDeleteById method"};if(0!==(yield this.model.updateOne({_id:e._id},{$set:{products:[]}})).modifiedCount){M.info("Products deleted from cart");const e=yield this.model.findOne({userId:t._id});return new this.DTO(e).toJson()}M.error("Products not deleted from cart")}))}addToCartById(t,e,r){return X(this,void 0,void 0,(function*(){const n=yield this.model.findOne({userId:t._id});if(null===n)M.error("Cart not found in addToCartById method.");else{let o=yield this.model.aggregate([{$match:{"products.productId":e}},{$project:{count:{$size:{$filter:{input:"$products",cond:{$eq:["$$this.productId",e]}}}}}},{$group:{_id:null,count:{$sum:"$count"}}}]);if(o&&o[0]){if(0!==(yield this.model.updateOne({_id:n._id,"products.productId":e},{$inc:{"products.$.quantity":r}})).modifiedCount){M.info("Product quantity succesfully updated!");const e=yield this.model.findOne({userId:t._id});return new this.DTO(e).toJson()}M.error("Product quantity could not been modified.")}else{const{name:o,price:i,description:s,photoURL:d}=yield zt.getProductById(e);if(0!==(yield this.model.updateOne({_id:n._id},{$push:{products:{productId:e,name:o,price:i,description:s,photoURL:d,quantity:r}}})).modifiedCount){M.info("Product succesfully added to cart!");const e=yield this.model.findOne({userId:t._id});return new this.DTO(e).toJson()}M.error("Product not added to cart.")}}}))}getProductsByCartId(t){return X(this,void 0,void 0,(function*(){const e=yield this.model.findOne({userId:t.id});if(null===e)return{error:"Cart not found"};{const t=new this.DTO(e).getProducts();return 0==t.products.length?{message:"There is no products in the cart."}:t}}))}deleteProductByCartId(t,e){return X(this,void 0,void 0,(function*(){const r=yield this.model.findOne({userId:t.id});return M.info(`cart: ${r}`),null===r?{error:"Cart not found"}:0!==(yield this.model.updateOne({_id:r._id},{$pull:{products:{productId:e}}})).modifiedCount?(M.info("Product succesfully deleted from cart!"),e):void M.error("Product not deleted from cart")}))}}const tt=Z.getInstance(k,Q),et=new(y().Schema)({user:{type:String,required:!0},products:[{type:Object,required:!0,ref:"products"}],status:{type:String,default:"generada"},timestamp:{type:String,required:!0,default:(new Date).toLocaleString()}}),rt=y().model("orders",et);var nt,ot,it,st,dt,at=function(t,e,r,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?o.call(t,r):o?o.value=r:e.set(t,r),r},ct=function(t,e,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(t):n?n.value:e.get(t)};nt=new WeakMap,ot=new WeakMap,it=new WeakMap,st=new WeakMap,dt=new WeakMap;const ut=require("nodemailer");var ht=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const lt=t.n(ut)().createTransport({service:"gmail",auth:{user:d.GMAIL_MAIL,pass:d.GMAIL_PROVISIONAL_PASS}}),ft=new class{constructor(){this.transporter=lt}newRegister(t){return ht(this,void 0,void 0,(function*(){try{yield this.transporter.sendMail({from:"E-commerce MK",to:d.GMAIL_MAIL,subject:"New registered user",html:` \n                        <h1>A new user has been registered!</h1>\n                        <br>\n                        <p>Name: ${t.name}</p> \n                        <p>eMail: ${t.email}</p>\n                        <p>Address: ${t.address}</p>   \n                        <p>Age: ${t.age}</p>\n                        <p>Phone Number: ${t.phoneNumber}</p>`})}catch(e){M.error(`An error has occurred when sending the user registration email: ${t.email}`)}}))}newOrder(t,e){return ht(this,void 0,void 0,(function*(){try{yield this.transporter.sendMail({from:"E-commerce MK",to:d.GMAIL_MAIL,subject:`New order from ${t.name}`,html:`\n                    <h5> User: </h5>\n                        <p>${t.name}</p> \n                        <p>${t.email}</p> \n                        <p>${t.phoneNumber}</p>\n                        </hr>\n            \n                        <h2> Pedido </h2>\n                        <table>\n                            <thead>\n                                <tr>\n                                    <th scope="col">Name</th>\n                                    <th scope="col">Price</th>\n                                    <th scope="col">Quantity</th>\n                                    <th scope="col">Description</th>\n                                    <th scope="col">Thumbnail</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                ${e.map((t=>`<tr>\n                                    <td>${t.name}</td>\n                                    <td>${t.price}</td>\n                                    <td>${t.quantity}</td>\n                                    <td>${t.description}</td>\n                                    <td><img style="max-width: 40px" src="${t.photoURL}"></img></td>\n                                </tr>`))}\n                            </tbody>\n                        </table>\n                        `})}catch(e){M.error(`An error has occurred when sending the user NewOrder email: ${t.email}`)}}))}},pt=require("twilio");var mt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const yt=d.TWILIO_ACCOUNTSID,vt=d.TWILIO_AUTH_TOKEN,wt=t.n(pt)()(yt,vt),gt=new class{newSMS(t){return mt(this,void 0,void 0,(function*(){try{yield wt.messages.create({body:"Your order has been received and is being process",from:d.TWILIO_NUMBER,to:t.phoneNumber})}catch(e){M.error(`An error has occurred when sending SMS: ${t.email}`)}}))}newWhatsapp(t){return mt(this,void 0,void 0,(function*(){try{yield wt.messages.create({body:`New order from ${t.name} - ${t.email}`,from:`whatsapp:${d.TWILIO_WHATSAPP}`,to:`whatsapp:${d.TWILIO_ADMIN_NUMBER}`})}catch(t){M.error("An error has occurred when sending a Whatsapp message")}}))}};class It extends class{constructor(){}createOrder(t){return e=this,r=void 0,o=function*(){throw new Error("Order - createOrder not Implemented")},new((n=void 0)||(n=Promise))((function(t,i){function s(t){try{a(o.next(t))}catch(t){i(t)}}function d(t){try{a(o.throw(t))}catch(t){i(t)}}function a(e){var r;e.done?t(e.value):(r=e.value,r instanceof n?r:new n((function(t){t(r)}))).then(s,d)}a((o=o.apply(e,r||[])).next())}));var e,r,n,o}}{constructor(t,e,r,n){super(),this.orderModel=t,this.cartModel=e,this.OrderDTO=r,this.CartDTO=n,T()}static getInstance(t,e){return this.instance||(this.instance=new It(t,k,e,Q)),this.instance}createOrder(t){return e=this,r=void 0,o=function*(){try{const e=yield this.cartModel.findOne({userId:t._id}),r=new this.CartDTO(e).getProducts();if(0==r.length)throw new Error("There is not products in the cart.");const n=yield this.orderModel.create({user:t.email,products:r.products,status:"generated"});yield ft.newOrder(t,r.products),yield gt.newSMS(t);const o=new this.OrderDTO(n).toJson();return yield this.cartModel.updateOne({_id:e._id},{$set:{products:[]}}),o}catch(t){M.error(`MongoAtlas createOrder method error: ${t}`)}},new((n=void 0)||(n=Promise))((function(t,i){function s(t){try{a(o.next(t))}catch(t){i(t)}}function d(t){try{a(o.throw(t))}catch(t){i(t)}}function a(e){var r;e.done?t(e.value):(r=e.value,r instanceof n?r:new n((function(t){t(r)}))).then(s,d)}a((o=o.apply(e,r||[])).next())}));var e,r,n,o}}const Pt=new It(rt,k,class{constructor(t){nt.set(this,void 0),ot.set(this,void 0),it.set(this,void 0),st.set(this,void 0),dt.set(this,void 0),at(this,nt,t._id,"f"),at(this,ot,t.timestamp,"f"),at(this,it,t.user,"f"),at(this,st,t.products,"f"),at(this,dt,t.status,"f")}toJson(){return{timestamp:ct(this,ot,"f"),user:ct(this,it,"f"),products:ct(this,st,"f"),status:ct(this,dt,"f")}}},Q),Ct=require("bcrypt");var Ot=t.n(Ct),Et=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const Mt=new(y().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0},name:{type:String,required:!0},address:{type:String,required:!0},age:{type:Number,required:!0},phoneNumber:{type:String,required:!0},picture:{type:String,required:!0},isAdmin:{type:Boolean,required:!0}},{collection:"users"});Mt.pre("save",(function(t){return Et(this,void 0,void 0,(function*(){const e=this;if(!e)return t();try{const r=yield Ot().genSalt(10),n=yield Ot().hash(e.password,r);e.password=n,t()}catch(e){t(e)}}))})),Mt.post("save",(function(t){return Et(this,void 0,void 0,(function*(){try{const e={id:this.id,email:this.email};yield ne.cartCreate(t,e)}catch(t){M.error(`Error trying to update user cartId: ${t}`)}}))})),Mt.methods.comparePassword=(t,e)=>Et(void 0,void 0,void 0,(function*(){return yield Ot().compareSync(t,e)}));const Tt=y().model("User",Mt);var $t,St,Bt,At,_t,bt,xt,Nt,qt,Ut=function(t,e,r,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?o.call(t,r):o?o.value=r:e.set(t,r),r},Lt=function(t,e,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(t):n?n.value:e.get(t)};$t=new WeakMap,St=new WeakMap,Bt=new WeakMap,At=new WeakMap,_t=new WeakMap,bt=new WeakMap,xt=new WeakMap,Nt=new WeakMap,qt=new WeakMap;class Dt extends class{constructor(){}signUp(t){return e=this,r=void 0,o=function*(){throw new Error("User - signUp not Implemented")},new((n=void 0)||(n=Promise))((function(t,i){function s(t){try{a(o.next(t))}catch(t){i(t)}}function d(t){try{a(o.throw(t))}catch(t){i(t)}}function a(e){var r;e.done?t(e.value):(r=e.value,r instanceof n?r:new n((function(t){t(r)}))).then(s,d)}a((o=o.apply(e,r||[])).next())}));var e,r,n,o}}{constructor(t,e){super(),this.model=t,this.DTO=e,T()}static getInstance(t,e){return this.instance||(this.instance=new Dt(t,e)),this.instance}save(t){return e=this,r=void 0,o=function*(){return yield this.model.create(t)},new((n=void 0)||(n=Promise))((function(t,i){function s(t){try{a(o.next(t))}catch(t){i(t)}}function d(t){try{a(o.throw(t))}catch(t){i(t)}}function a(e){var r;e.done?t(e.value):(r=e.value,r instanceof n?r:new n((function(t){t(r)}))).then(s,d)}a((o=o.apply(e,r||[])).next())}));var e,r,n,o}}const jt=Dt.getInstance(Tt,class{constructor(t){$t.set(this,void 0),St.set(this,void 0),Bt.set(this,void 0),At.set(this,void 0),_t.set(this,void 0),bt.set(this,void 0),xt.set(this,void 0),Nt.set(this,void 0),qt.set(this,void 0),Ut(this,$t,t._id,"f"),Ut(this,St,t.email,"f"),Ut(this,Bt,t.password,"f"),Ut(this,At,t.name,"f"),Ut(this,_t,t.address,"f"),Ut(this,bt,t.age,"f"),Ut(this,xt,t.phoneNumber,"f"),Ut(this,Nt,t.picture,"f"),Ut(this,qt,t.isAdmin,"f")}chatUser(){return{id:Lt(this,$t,"f"),email:Lt(this,St,"f"),isAdmin:Lt(this,qt,"f")}}toJson(){return{id:Lt(this,$t,"f"),email:Lt(this,St,"f"),password:Lt(this,Bt,"f"),name:Lt(this,At,"f"),address:Lt(this,_t,"f"),age:Lt(this,bt,"f"),number:Lt(this,xt,"f"),picture:Lt(this,Nt,"f"),isAdmin:Lt(this,qt,"f")}}}),Rt=new(y().Schema)({mail:{type:String,required:!0},body:{type:String,required:!0},timestamp:{type:String,required:!0}}),Wt=y().model("chats",Rt);var kt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};var Gt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};class Ft extends class{constructor(){}addMessage(t){return kt(this,void 0,void 0,(function*(){throw new Error("Chat - addMessage not Implemented")}))}getMessages(){return kt(this,void 0,void 0,(function*(){throw new Error("Chat - getMessages not Implemented")}))}}{constructor(t,e){super(),this.chatModel=t,this.ChatDTO=e,T()}static getInstance(t,e){return this.instance||(this.instance=new Ft(t,e)),this.instance}addMessage(t){return Gt(this,void 0,void 0,(function*(){const e=new this.chatModel(t);yield e.save()}))}getMessages(){return Gt(this,void 0,void 0,(function*(){const t=yield this.chatModel.find();if(null===t)throw new Error("Your chat is empty.");return t.map((t=>new this.ChatDTO(t).getMessages()))}))}}const Jt=Ft.getInstance(Wt,class{constructor(t){this.mail=t.mail,this.body=t.body,this.timestamp=t.timestamp}getMessages(){return{mail:this.mail,body:this.body,timestamp:this.timestamp}}}),Ht=d.PERSISTENCE,Yt=t=>class{static getPersistence(t,e){try{if("products"===e)return R;if("cart"===e)return tt;if("order"===e)return Pt;if("user"===e)return jt;if("chat"===e)return Jt;throw new Error("Persistence not found")}catch(t){console.log(t),M.error("Persistence type not found")}}}.getPersistence(Ht,t);var Kt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const Vt=Yt("products"),zt=new class{constructor(t){this.model=t}getAllProducts(){return Kt(this,void 0,void 0,(function*(){return yield this.model.getAll()}))}getProductById(t){return Kt(this,void 0,void 0,(function*(){return yield this.model.getById(t)}))}getProductByCategory(t){return Kt(this,void 0,void 0,(function*(){return yield this.model.getByCategory(t)}))}addProduct(t){return Kt(this,void 0,void 0,(function*(){return yield this.model.addProduct(t)}))}updateProductById(t,e){return Kt(this,void 0,void 0,(function*(){return yield this.model.updateProductById(t,e)}))}deleteProductById(t){return Kt(this,void 0,void 0,(function*(){return yield this.model.deleteProductById(t)}))}}(Vt);var Qt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const Xt=new class{constructor(){}getAll(t,e){return Qt(this,void 0,void 0,(function*(){M.info(`${t.method} request to '${t.originalUrl}' route: Getting all products from DB`);try{const t=yield zt.getAllProducts();return e.status(200).json({products:t})}catch(t){return M.error(`Error in getAll method: ${t}`),e.status(500).json({error:"An error has occurred."})}}))}getById(t,e){return Qt(this,void 0,void 0,(function*(){M.info(`${t.method} request to '${t.originalUrl}' route: Getting product by id from DB`);try{const{id:r}=t.params,n=yield zt.getProductById(r);return null==n?e.status(404).json({error:"Cannot find requested product"}):e.status(200).json({product:n})}catch(t){return M.error(`Error in getById method: ${t}`),e.status(500).json({error:"An error has occurred."})}}))}getByCategory(t,e){return Qt(this,void 0,void 0,(function*(){M.info(`${t.method} request to '${t.originalUrl}' route: Getting product by category from DB`);try{const{category:r}=t.params,n=yield zt.getProductByCategory(r);return null==n||0===n.length?e.status(404).json({error:`Cannot find products belonging to ${r} category`}):e.status(200).json({ProductsByCategories:n})}catch(t){return M.error(`Error in getById method: ${t}`),e.status(500).json({error:"An error has occurred."})}}))}addProduct(t,e){return Qt(this,void 0,void 0,(function*(){M.info(`${t.method} request to '${t.originalUrl}' route: Adding new product to DB`);try{const r=t.body,n=yield zt.addProduct(r);return e.status(200).json({ProductAdded:n})}catch(t){return M.error(`Error in addProduct method: ${t}`),e.status(500).json({error:"An error has occurred."})}}))}updateProductById(t,e){return Qt(this,void 0,void 0,(function*(){M.info(`${t.method} request to '${t.originalUrl}' route: Updating product at DB`);try{const{id:r}=t.params,n=t.body,o=yield zt.updateProductById(r,n);return null==o?e.status(404).json({error:"Cannot find requested product"}):e.status(200).json({ProductUpdated:o})}catch(t){return M.error(`Error in updateProductById method: ${t}`),e.status(500).json({error:"An error has occurred."})}}))}deleteProductById(t,e){return Qt(this,void 0,void 0,(function*(){M.info(`${t.method} request to '${t.originalUrl}' route: Deleting product by id from DB`);try{const{id:r}=t.params,n=yield zt.deleteProductById(r);return null==n?e.status(404).json({error:"Cannot find requested product"}):e.status(200).json({ProductDeleted:n})}catch(t){M.error(`Error in deleteProductById method: ${t}`)}}))}};var Zt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const te=Yt("cart"),ee=new class{constructor(t){this.model=t}createNewCart(t){return Zt(this,void 0,void 0,(function*(){return yield this.model.createNewCart(t)}))}deleteCartProducts(t){return Zt(this,void 0,void 0,(function*(){return yield this.model.deleteCartProducts(t)}))}getProductsByCartId(t){return Zt(this,void 0,void 0,(function*(){return yield this.model.getProductsByCartId(t)}))}addToCartById(t,e,r){return Zt(this,void 0,void 0,(function*(){return yield this.model.addToCartById(t,e,r)}))}deleteProductByCartId(t,e){return Zt(this,void 0,void 0,(function*(){return yield this.model.deleteProductByCartId(t,e)}))}}(te);var re=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const ne=new class{constructor(){}cartCreate(t,e){return re(this,void 0,void 0,(function*(){try{yield ee.createNewCart(e),M.info(`Cart created for user ${e.email}`)}catch(e){return M.error(`Error in cartCreate method: ${e}`),t.status(500).json({error:"An error has occurred."})}}))}deleteCartProducts(t,e){return re(this,void 0,void 0,(function*(){try{const r=t.user,n=yield ee.deleteCartProducts(r);return e.status(200).json({Cart:n})}catch(t){M.error(`Error in cartProdDeleteById method: ${t}`)}}))}getProductsByCartId(t,e){return re(this,void 0,void 0,(function*(){M.info(`${t.method} request to '${t.originalUrl}' route: Getting products by Cart ID.`);try{const r=t.user,n=yield ee.getProductsByCartId(r);return e.status(200).json({User_Cart:n})}catch(t){M.error(`Error in getProductsByCartId method: ${t}`)}}))}addToCartById(t,e){return re(this,void 0,void 0,(function*(){try{const r=t.user,n=t.body.quantity,{productId:o}=t.params,i=yield ee.addToCartById(r,o,n);return e.status(200).json({Cart:i})}catch(t){M.error(`Error in addToCartById method: ${t}`)}}))}deleteProductByCartId(t,e){return re(this,void 0,void 0,(function*(){try{const r=t.user,{productId:n}=t.params,o=yield ee.deleteProductByCartId(r,n);return e.status(200).json({ProductDeleted_ID:o})}catch(t){M.error(`Error in deleteProductByCartId method: ${t}`)}}))}cartOrder(t,e){return re(this,void 0,void 0,(function*(){try{const r=t.user,n=yield ee.getProductsByCartId(r);ft.newOrder(r,n),gt.newSMS(r),gt.newWhatsapp(r),e.redirect("/")}catch(t){M.error(`Error in getProductsByCartId method: ${t}`)}}))}};var oe=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const ie=new class{constructor(){}login(t,e,r){return oe(this,void 0,void 0,(function*(){try{t.isAuthenticated()&&e.status(200).json({message:"User logged"})}catch(t){M.error(`Error when login method in SessionControllers, ${t}`)}}))}renderFailedLogin(t,e){return oe(this,void 0,void 0,(function*(){e.status(403).json({error:t.flash("error")[0]})}))}logout(t,e){return oe(this,void 0,void 0,(function*(){try{t.isAuthenticated()&&t.session.destroy((()=>{e.status(200).json({message:"User logged out"})}))}catch(t){M.error(`Error when logout method in SessionControllers, ${t}`)}}))}signUp(t,e,r){return oe(this,void 0,void 0,(function*(){try{e.status(200).json({message:"User registered"})}catch(t){M.error(`Error when signup method in SessionControllers, ${t}`)}}))}failedSignup(t,e){return oe(this,void 0,void 0,(function*(){e.status(409).json({error:t.flash("error")[0]})}))}uploadSuccess(t,e,r){return oe(this,void 0,void 0,(function*(){e.status(200).json({message:"Photo Uploaded"})}))}};const se=Yt("order"),de=new class{constructor(t){this.model=t}createOrder(t){return e=this,r=void 0,o=function*(){return yield this.model.createOrder(t)},new((n=void 0)||(n=Promise))((function(t,i){function s(t){try{a(o.next(t))}catch(t){i(t)}}function d(t){try{a(o.throw(t))}catch(t){i(t)}}function a(e){var r;e.done?t(e.value):(r=e.value,r instanceof n?r:new n((function(t){t(r)}))).then(s,d)}a((o=o.apply(e,r||[])).next())}));var e,r,n,o}}(se);const ae=new class{constructor(){}createOrder(t,e){return r=this,n=void 0,i=function*(){try{const r=t.user,n=yield de.createOrder(r);return e.status(200).json({order:n})}catch(t){M.error(`Error in createOrder method, Order Controller: ${t}`)}},new((o=void 0)||(o=Promise))((function(t,e){function s(t){try{a(i.next(t))}catch(t){e(t)}}function d(t){try{a(i.throw(t))}catch(t){e(t)}}function a(e){var r;e.done?t(e.value):(r=e.value,r instanceof o?r:new o((function(t){t(r)}))).then(s,d)}a((i=i.apply(r,n||[])).next())}));var r,n,o,i}};const ce=new class{constructor(){}infoRender(t,e){return r=this,n=void 0,i=function*(){try{return e.render("info",{config:d})}catch(t){M.error(`Error in infoRender method, Info Controller: ${t}`)}},new((o=void 0)||(o=Promise))((function(t,e){function s(t){try{a(i.next(t))}catch(t){e(t)}}function d(t){try{a(i.throw(t))}catch(t){e(t)}}function a(e){var r;e.done?t(e.value):(r=e.value,r instanceof o?r:new o((function(t){t(r)}))).then(s,d)}a((i=i.apply(r,n||[])).next())}));var r,n,o,i}};const ue=new class{constructor(){}renderChatForm(t,e){return r=this,n=void 0,i=function*(){try{e.status(200).render("home")}catch(t){M.error(`Error in renderChatForm method, chatController: ${t}`)}},new((o=void 0)||(o=Promise))((function(t,e){function s(t){try{a(i.next(t))}catch(t){e(t)}}function d(t){try{a(i.throw(t))}catch(t){e(t)}}function a(e){var r;e.done?t(e.value):(r=e.value,r instanceof o?r:new o((function(t){t(r)}))).then(s,d)}a((i=i.apply(r,n||[])).next())}));var r,n,o,i}},he=(0,e.Router)();he.route("/").get(Xt.getAll).post(Xt.addProduct),he.route("/id/:id").get(Xt.getById).put(Xt.updateProductById).delete(Xt.deleteProductById),he.route("/categories/:category").get(Xt.getByCategory);const le=he,fe=(0,e.Router)();fe.route("/").post(ne.cartCreate).get(ne.getProductsByCartId).delete(ne.deleteCartProducts),fe.route("/addProduct/:productId").post(ne.addToCartById),fe.route("/:productId").delete(ne.deleteProductByCartId);const pe=fe,me=(0,e.Router)();me.route("/").post(ae.createOrder);const ye=me,ve=(0,e.Router)();ve.route("/").get(ce.infoRender);const we=ve,ge=(0,e.Router)();ge.route("/").get(ue.renderChatForm);const Ie=ge,Pe=require("passport");var Ce=t.n(Pe);const Oe=(0,e.Router)();Oe.post("/",Ce().authenticate("login",{failureRedirect:"/login/failed",failureFlash:!0}),ie.login),Oe.get("/failed",ie.renderFailedLogin);const Ee=(0,e.Router)();Ee.post("/",ie.logout);const Me=require("multer");var Te=t.n(Me);const $e=Te().diskStorage({destination:function(t,e,r){r(null,"uploads")},filename:function(t,e,r){r(null,`${Date.now()}-${e.originalname}`)}}),Se=Te()({storage:$e});var Be=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const Ae=(0,e.Router)();Ae.post("/",Ce().authenticate("signup",{failureRedirect:"/signup/failed",failureFlash:!0}),((t,e)=>Be(void 0,void 0,void 0,(function*(){e.status(200).json({message:"User registered"})})))),Ae.post("/upload",Se.single("picture"),((t,e,r)=>Be(void 0,void 0,void 0,(function*(){const e=t.file;if(!e)return r({message:"Error when uploading file.",statusCode:400});const n={email:t.user.email,password:t.user.password,name:t.user.name,address:t.user.address,age:t.user.age,phoneNumber:t.user.phoneNumber,picture:`${e.filename}`,isAdmin:t.user.isAdmin};try{if(0===(yield Tt.updateOne({_id:t.user.id},n)).matchedCount)return r({message:"User not found",statusCode:400})}catch(t){M.error(`Error trying to update users avatar: ${t}`)}r()}))),ie.uploadSuccess),Ae.get("/failed",ie.failedSignup);const _e=(0,e.Router)();_e.use("/login",Oe),_e.use("/logout",Ee),_e.use("/signup",Ae),_e.use("/api/products",le),_e.use("/api/cart",pe),_e.use("/api/order",ye),_e.use("/api/info",we),_e.use("/api/chat",Ie);const be=_e,xe=require("connect-flash");var Ne=t.n(xe);const qe=require("cookie-parser");var Ue=t.n(qe);const Le=require("passport-local");const De=Yt("user"),je=new class{constructor(t){this.model=t}saveUser(t){return e=this,r=void 0,o=function*(){return yield this.model.save(t)},new((n=void 0)||(n=Promise))((function(t,i){function s(t){try{a(o.next(t))}catch(t){i(t)}}function d(t){try{a(o.throw(t))}catch(t){i(t)}}function a(e){var r;e.done?t(e.value):(r=e.value,r instanceof n?r:new n((function(t){t(r)}))).then(s,d)}a((o=o.apply(e,r||[])).next())}));var e,r,n,o}}(De);var Re=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const We=require("path");var ke=t.n(We),Ge=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const Fe=Yt("chat"),Je=new class{constructor(t){this.model=t}getMessages(){return Ge(this,void 0,void 0,(function*(){try{return yield this.model.getMessages()}catch(t){M.error(`Error in getMessages method: ${t}`)}}))}addMessage(t){return Ge(this,void 0,void 0,(function*(){try{yield this.model.addMessage(t)}catch(t){M.error(`Error in getMessages method: ${t}`)}}))}}(Fe);var He=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function d(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}a((n=n.apply(t,e||[])).next())}))};const Ye=d.PORT,Ke=r()();if("CLUSTER"===process.argv[3]&&h().isPrimary){const t=f().cpus().length;M.info(`Number of CPUs: ${t}`),M.info(`Master PID ${process.pid} is running`);for(let e=0;e<t;e++)h().fork();h().on("exit",((t,e,r)=>{M.info(`Worker ${t.process.pid} died`),h().fork()}))}else{const t=Ke.listen(Ye,(()=>{M.info(`Server listening on port ${Ye}.`,`Process ID: ${process.pid}.`)}));t.on("error",(t=>M.error(`An error has ocurred when starting: ${t}`)));const e=new p.Server(t);e.on("connection",(t=>He(void 0,void 0,void 0,(function*(){console.log(`New user connected: ${t.id}`);let r=yield Je.getMessages();t.emit("server:message",r);try{t.on("client:message",(t=>He(void 0,void 0,void 0,(function*(){try{yield Je.addMessage(t),r=yield Je.getMessages()}catch(t){M.error(`Error in addMessage socket method: ${t}`)}e.emit("server:message",r)}))))}catch(t){M.error(`Error at receiving client:message socket method: ${t}`)}}))))}Ke.use(r().static(ke().join(__dirname,"../public"))),Ke.use(r().static(ke().join(__dirname,"../uploads"))),Ke.use(r().json()),Ke.use(Ue()()),Ke.use(r().urlencoded({extended:!0})),Ke.set("views",ke().join(__dirname,"../api/views")),Ke.set("view engine","ejs");const Ve=d.MONGO_OPTIONS;Ke.use(o()({store:c().create({mongoUrl:d.MONGO_ATLAS_URL,mongoOptions:Ve}),secret:d.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:Number(d.SESSION_TIME)}})),Ke.use(Ce().initialize()),Ke.use(Ce().session()),Ke.use(Ne()()),function(t){t.use("login",new Le.Strategy({usernameField:"email",passwordField:"password"},((t,e,r)=>Re(this,void 0,void 0,(function*(){try{const n=yield Tt.findOne({email:t}).exec();return n?(yield n.comparePassword(e,n.password))?(M.info(n),r(null,n)):r(null,!1,{message:"Wrong password"}):r(null,!1,{message:"User doesn't exist"})}catch(t){r(t)}}))))),t.use("signup",new Le.Strategy({passReqToCallback:!0,usernameField:"email"},((t,e,r,n)=>Re(this,void 0,void 0,(function*(){const o=new Tt({email:e,password:r,name:t.body.name,address:t.body.address,age:t.body.age,phoneNumber:`+54${t.body.phoneNumber}`,picture:"avatar.png",isAdmin:"false"});try{const t=yield je.saveUser(o);return n(null,t)}catch(t){return 11e3===t.code?n(null,!1,{message:"User already exists"}):(M.error(t),n(t))}}))))),t.serializeUser(((t,e)=>{e(null,t._id)})),t.deserializeUser(((t,e)=>Re(this,void 0,void 0,(function*(){const r=yield Tt.findById(t);e(null,r)}))))}(Ce()),Ke.use("/",be),Ke.use(((t,e,r,n)=>{e.user;try{return M.error(`An error has occured: ${t.message}`),r.status(500).json({error:"An error has occured, captured by errorHandler"})}catch(t){return r.status(500).json({error:"An error has occured, captured by errorHandler"})}})),Ke.use(((t,e,r)=>{e.status(404).json({status:404,message:`Route: ${t.originalUrl}, not implemented.`,error:"Not Found"})}))})();