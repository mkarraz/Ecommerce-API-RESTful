(()=>{"use strict";var e={n:n=>{var r=n&&n.__esModule?()=>n.default:()=>n;return e.d(r,{a:r}),r},d:(n,r)=>{for(var o in r)e.o(r,o)&&!e.o(n,o)&&Object.defineProperty(n,o,{enumerable:!0,get:r[o]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)};const n=require("express");var r=e.n(n);const o=require("express-session");var t=e.n(o);const s=require("mongoose");var i=e.n(s);const a=require("bcrypt");var c=e.n(a),u=function(e,n,r,o){return new(r||(r=Promise))((function(t,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((o=o.apply(e,n||[])).next())}))};const l=new(i().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0}},{collection:"users"});l.pre("save",(function(e){return u(this,void 0,void 0,(function*(){const n=this;if(!n)return e();try{const r=yield c().genSalt(10),o=yield c().hash(n.password,r);n.password=o,e()}catch(n){e(n)}}))})),l.methods.comparePassword=(e,n)=>u(void 0,void 0,void 0,(function*(){return yield c().compareSync(e,n)}));const d=i().model("User",l),f=require("fs");var v=e.n(f);const m=require("normalizr"),p=(e,n)=>{const r=new m.schema.Entity("author",{},{idAttribute:"userEmail"}),o=new m.schema.Entity("message",{author:r},{idAttribute:"id"}),t=new m.schema.Entity("messages",{messages:[o]},{idAttribute:"id"});return"normalize"==e?(0,m.normalize)({id:"messages",messages:n},t):(0,m.denormalize)(n.result,t,n.entities)},g=require("util");var h=e.n(g);const w=require("winston");var y=e.n(w);const q=require("dotenv");var P=e.n(q);P().config();const b=process.env.ENVIRONMENT_MODE||"development";y().addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const x=y().format.combine(y().format.timestamp({format:"DD-MM-YYYY HH:mm:ss:ms"}),y().format.printf((e=>`${e.timestamp} ${e.level}: ${e.message}`))),O=[new(y().transports.Console)({format:y().format.combine(y().format.colorize({all:!0}),x)}),new(y().transports.File)({filename:"logs/warn.log",level:"warn",format:x}),new(y().transports.File)({filename:"logs/error.log",level:"error",format:x})],R=y().createLogger({level:"development"===b?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},transports:O});var S=function(e,n,r,o){return new(r||(r=Promise))((function(t,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((o=o.apply(e,n||[])).next())}))};function N(e){R.info(h().inspect(e,!1,12,!0))}const U=new class extends class{constructor(e){this.filePath=e}}{constructor(){super("./DB/chat.json")}readChatFromFile(){return S(this,void 0,void 0,(function*(){try{const e=yield v().promises.readFile(this.filePath,"utf8"),n=JSON.parse(e),r=p("denormalize",n);return R.info("Denormalized"),N(r),r}catch(e){R.error("File cannot be read "+e)}}))}writeChatToFile(e){return S(this,void 0,void 0,(function*(){try{const n=p("normalize",e);R.info("Normalized"),N(n),yield v().promises.writeFile(this.filePath,JSON.stringify(n))}catch(e){R.error("File cannot be written "+e)}}))}},F=require("path");var z=e.n(F);(0,q.config)({path:F.resolve(__dirname,"../../.env")});const $={admin:!0,hostNanme:"http://localhost:8080",PORT:process.argv[2]||parseInt(process.env.PORT)};P().config();const D={mongoDB:{URI:`mongodb+srv://${process.env.MONGOUSR}:${process.env.MONGOPWD}@${process.env.MONGOCLUSTER}.mongodb.net/?retryWrites=true&w=majority`}},E=require("connect-mongo");var C=e.n(E);const _=require("socket.io"),M=require("cluster");var T=e.n(M);const j=require("os");var A=e.n(j);const I=require("passport");var k=e.n(I);const B=require("passport-local");var J=function(e,n,r,o){return new(r||(r=Promise))((function(t,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((o=o.apply(e,n||[])).next())}))};const Y=(0,n.Router)();k().use("login",new B.Strategy({usernameField:"email",passwordField:"password"},((e,n,r)=>{return o=void 0,t=void 0,i=function*(){try{const o=yield d.findOne({email:e}).exec();return o?(yield o.comparePassword(n,o.password))?(R.info(o),r(null,o)):r(null,!1,{message:"Wrong password"}):r(null,!1,{message:"User doesn't exist"})}catch(e){r(e)}},new((s=void 0)||(s=Promise))((function(e,n){function r(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(n){var o;n.done?e(n.value):(o=n.value,o instanceof s?o:new s((function(e){e(o)}))).then(r,a)}c((i=i.apply(o,t||[])).next())}));var o,t,s,i}))),Y.get("/",((e,n)=>{e.isAuthenticated()?n.redirect("/"):n.render("login")})),Y.post("/",k().authenticate("login",{failureRedirect:"/login/failed",failureFlash:!0}),((e,n,r)=>J(void 0,void 0,void 0,(function*(){n.status(200).render("home",{user:e.user}),r()})))),Y.get("/failed",((e,n)=>{n.status(401).render("failedLogin",{message:e.flash("error")[0]})}));const L=Y,W=(0,n.Router)();W.post("/",((e,n)=>{e.session.destroy((()=>{n.render("login")}))}));const G=W;const H=(0,n.Router)();k().use("signup",new B.Strategy({usernameField:"email",passwordField:"password"},((e,n,r)=>{return o=void 0,t=void 0,i=function*(){const o=new d({email:e,password:n});try{return yield o.save(),r(null,o)}catch(e){return 11e3===e.code?r(null,!1,{message:"User already exists"}):(R.error(e),r(e))}},new((s=void 0)||(s=Promise))((function(e,n){function r(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(n){var o;n.done?e(n.value):(o=n.value,o instanceof s?o:new s((function(e){e(o)}))).then(r,a)}c((i=i.apply(o,t||[])).next())}));var o,t,s,i}))),H.get("/",((e,n)=>J(void 0,void 0,void 0,(function*(){e.isAuthenticated()?n.redirect("/"):n.render("signup")})))),H.post("/",k().authenticate("signup",{failureRedirect:"/signup/failed",failureFlash:!0}),((e,n,r)=>J(void 0,void 0,void 0,(function*(){n.status(201).render("createdUser",{user:e.user}),r()})))),H.get("/failed",((e,n)=>J(void 0,void 0,void 0,(function*(){n.status(409).render("failedSignup",{message:e.flash("error")[0]})}))));const K=H,V=require("child_process"),Q=(0,n.Router)();Q.get("/",((e,n)=>{const{amount:r}=e.query;let o=Number(r);o||(o=1e8);const t=(0,V.fork)("./api/utils/getRandomNumbers.js");t.send(o),t.on("message",(e=>{n.end(JSON.stringify(e,null,3))})),t.on("exit",(e=>{R.info("Se ha cerrado el proceso",e)}))}));const X=Q,Z=(0,n.Router)();Z.get("/",((e,n)=>{const r={numberOfProcessors:A().cpus().length,title:process.argv,arguments:process.argv,system:process.platform,version:process.version,memory:process.memoryUsage.rss(),path:process.execPath,id:process.pid,folder:process.cwd()};return console.log(r),n.render("info",r)}));const ee=Z,ne=require("connect-flash");var re=e.n(ne);const oe=require("cookie-parser");var te=e.n(oe);const se=require("compression");var ie=e.n(se),ae=function(e,n,r,o){return new(r||(r=Promise))((function(t,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}c((o=o.apply(e,n||[])).next())}))};R.info("Informaci√≥n"),R.debug("Debug"),R.warn("Advertencia"),R.error("Error");const ce=$.PORT||8081,ue=r()();if("CLUSTER"===process.argv[3]&&T().isPrimary){const e=A().cpus().length;R.info(`Number of CPUs: ${e}`),R.info(`Master PID ${process.pid} is running`);for(let n=0;n<e;n++)T().fork();T().on("exit",((e,n,r)=>{R.info(`Worker ${e.process.pid} died`),T().fork()}))}else{ue.use("/api/randoms",X);const e=ue.listen(ce,(()=>{R.info(`Server listening on port ${ce}.`,`Process ID: ${process.pid}.`)}));e.on("error",(e=>R.error(`An error has ocurred when starting: ${e}`)));const n=new _.Server(e);let r=[];n.on("connection",(e=>ae(void 0,void 0,void 0,(function*(){R.info(`New user connected: ${e.id}`),e.emit("server:message",r),e.on("client:message",(e=>ae(void 0,void 0,void 0,(function*(){e.id=r.length+1,r.push(e),U.writeChatToFile(r);const o=r,t=p("normalize",r);let s=Math.round(100*(1-JSON.stringify(t).length/JSON.stringify(o).length));R.info("Comnpression Rate: ",s),n.emit("server:message",r)}))))}))))}ue.use(r().static(z().join(__dirname,"../public"))),ue.use(r().json()),ue.use(te()()),ue.use(r().urlencoded({extended:!0})),ue.set("views",z().join(__dirname,"../api/views")),ue.set("view engine","ejs");const le={useNewUrlParser:!0,useUnifiedTopology:!0};ue.use(t()({store:C().create({mongoUrl:D.mongoDB.URI,mongoOptions:le}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),i().connect(D.mongoDB.URI,le,(e=>{try{R.info("Connected to MongoDB Atlas")}catch(e){R.error(`${e}`)}})),ue.use(k().initialize()),ue.use(k().session()),ue.use(re()()),k().serializeUser(((e,n)=>{n(null,e._id)})),k().deserializeUser(((e,n)=>ae(void 0,void 0,void 0,(function*(){const r=yield d.findById(e);n(null,r)})))),ue.use("/login",L),ue.use("/logout",G),ue.use("/signup",K),ue.get("/",((e,n)=>ae(void 0,void 0,void 0,(function*(){n.render("home",{logged:!0,user:e.user})})))),ue.use("/info",ee),ue.use("/infoCompressed",ie()(),ee)})();