(()=>{"use strict";var e={n:r=>{var o=r&&r.__esModule?()=>r.default:()=>r;return e.d(o,{a:o}),o},d:(r,o)=>{for(var n in o)e.o(o,n)&&!e.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:o[n]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r)};const r=require("express");var o=e.n(r);const n=require("express-session");var s=e.n(n);const t=require("mongoose");var i=e.n(t);const a=require("bcrypt");var c=e.n(a),u=function(e,r,o,n){return new(o||(o=Promise))((function(s,t){function i(e){try{c(n.next(e))}catch(e){t(e)}}function a(e){try{c(n.throw(e))}catch(e){t(e)}}function c(e){var r;e.done?s(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,a)}c((n=n.apply(e,r||[])).next())}))};const l=new(i().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0}},{collection:"users"});l.pre("save",(function(e){return u(this,void 0,void 0,(function*(){const r=this;if(!r)return e();try{const o=yield c().genSalt(10),n=yield c().hash(r.password,o);r.password=n,e()}catch(r){e(r)}}))})),l.methods.comparePassword=(e,r)=>u(void 0,void 0,void 0,(function*(){return yield c().compareSync(e,r)}));const d=i().model("User",l),p=require("dotenv");var m=e.n(p);m().config();const f={mongoDB:{URI:`mongodb+srv://${process.env.MONGOUSR}:${process.env.MONGOPWD}@${process.env.MONGOCLUSTER}.mongodb.net/?retryWrites=true&w=majority`}},v=require("connect-mongo");var g=e.n(v);const w=require("cluster");var h=e.n(w);const y=require("os");var q=e.n(y);const b=require("child_process"),U=require("winston");var O=e.n(U);m().config();const P=process.env.ENVIRONMENT_MODE||"development";O().addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const S=O().format.combine(O().format.timestamp({format:"DD-MM-YYYY HH:mm:ss:ms"}),O().format.printf((e=>`${e.timestamp} ${e.level}: ${e.message}`))),$=[new(O().transports.Console)({format:O().format.combine(O().format.colorize({all:!0}),S)}),new(O().transports.File)({filename:"logs/warn.log",level:"warn",format:S}),new(O().transports.File)({filename:"logs/error.log",level:"error",format:S})],x=O().createLogger({level:"development"===P?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},transports:$}),D=(0,r.Router)();D.get("/",((e,r)=>{const{amount:o}=e.query;let n=Number(o);n||(n=1e8);const s=(0,b.fork)("./api/utils/getRandomNumbers.js");s.send(n),s.on("message",(e=>{r.end(JSON.stringify(e,null,3))})),s.on("exit",(e=>{x.info("Se ha cerrado el proceso",e)}))}));const N=D,R=(0,r.Router)();R.get("/",((e,r)=>{const o={numberOfProcessors:q().cpus().length,title:process.argv,arguments:process.argv,system:process.platform,version:process.version,memory:process.memoryUsage.rss(),path:process.execPath,id:process.pid,folder:process.cwd()};return console.log(o),r.render("info",o)}));const M=R,_=require("connect-flash");var E=e.n(_);const j=require("cookie-parser");var C=e.n(j);const I=require("passport");var k=e.n(I);const z=require("path");var B=e.n(z);const T=require("compression");var Y=e.n(T);x.info("Informaci√≥n"),x.debug("Debug"),x.warn("Advertencia"),x.error("Error");const A=o()();if("CLUSTER"===process.argv[3]&&h().isPrimary){const e=q().cpus().length;x.info(`Number of CPUs: ${e}`),x.info(`Master PID ${process.pid} is running`);for(let r=0;r<e;r++)h().fork();h().on("exit",((e,r,o)=>{x.info(`Worker ${e.process.pid} died`),h().fork()}))}else A.use("/api/randoms",N),A.listen(8081,(()=>{x.info("Server listening on port 8081.",`Process ID: ${process.pid}.`)})).on("error",(e=>x.error(`An error has ocurred when starting: ${e}`)));A.use(o().static(B().join(__dirname,"../public"))),A.use(o().json()),A.use(C()()),A.use(o().urlencoded({extended:!0})),A.set("views",B().join(__dirname,"../api/views")),A.set("view engine","ejs");const G={useNewUrlParser:!0,useUnifiedTopology:!0};A.use(s()({store:g().create({mongoUrl:f.mongoDB.URI,mongoOptions:G}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),i().connect(f.mongoDB.URI,G,(e=>{try{x.info("Connected to MongoDB Atlas")}catch(e){x.error(`${e}`)}})),A.use(k().initialize()),A.use(k().session()),A.use(E()()),k().serializeUser(((e,r)=>{r(null,e._id)})),k().deserializeUser(((e,r)=>{return o=void 0,n=void 0,t=function*(){const o=yield d.findById(e);r(null,o)},new((s=void 0)||(s=Promise))((function(e,r){function i(e){try{c(t.next(e))}catch(e){r(e)}}function a(e){try{c(t.throw(e))}catch(e){r(e)}}function c(r){var o;r.done?e(r.value):(o=r.value,o instanceof s?o:new s((function(e){e(o)}))).then(i,a)}c((t=t.apply(o,n||[])).next())}));var o,n,s,t})),A.use("/info",M),A.use("/infoCompressed",Y()(),M)})();