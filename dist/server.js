(()=>{"use strict";var e={n:r=>{var o=r&&r.__esModule?()=>r.default:()=>r;return e.d(o,{a:o}),o},d:(r,o)=>{for(var n in o)e.o(o,n)&&!e.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:o[n]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r)};const r=require("express");var o=e.n(r);const n=require("express-session");var s=e.n(n);const t=require("mongoose");var i=e.n(t);const a=require("bcrypt");var c=e.n(a),u=function(e,r,o,n){return new(o||(o=Promise))((function(s,t){function i(e){try{c(n.next(e))}catch(e){t(e)}}function a(e){try{c(n.throw(e))}catch(e){t(e)}}function c(e){var r;e.done?s(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,a)}c((n=n.apply(e,r||[])).next())}))};const l=new(i().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0}},{collection:"users"});l.pre("save",(function(e){return u(this,void 0,void 0,(function*(){const r=this;if(!r)return e();try{const o=yield c().genSalt(10),n=yield c().hash(r.password,o);r.password=n,e()}catch(r){e(r)}}))})),l.methods.comparePassword=(e,r)=>u(void 0,void 0,void 0,(function*(){return yield c().compareSync(e,r)}));const p=i().model("User",l),d=require("dotenv");var m=e.n(d);const v=require("path");var f=e.n(v);(0,d.config)({path:v.resolve(__dirname,"../../.env")});const g={admin:!0,hostNanme:"http://localhost:8080",PORT:process.argv[2]||parseInt(process.env.PORT)};m().config();const h={mongoDB:{URI:`mongodb+srv://${process.env.MONGOUSR}:${process.env.MONGOPWD}@${process.env.MONGOCLUSTER}.mongodb.net/?retryWrites=true&w=majority`}},w=require("connect-mongo");var y=e.n(w);const q=require("cluster");var b=e.n(q);const O=require("os");var P=e.n(O);const U=require("child_process"),R=require("winston");var $=e.n(R);m().config();const N=process.env.ENVIRONMENT_MODE||"development";$().addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const S=$().format.combine($().format.timestamp({format:"DD-MM-YYYY HH:mm:ss:ms"}),$().format.printf((e=>`${e.timestamp} ${e.level}: ${e.message}`))),_=[new($().transports.Console)({format:$().format.combine($().format.colorize({all:!0}),S)}),new($().transports.File)({filename:"logs/warn.log",level:"warn",format:S}),new($().transports.File)({filename:"logs/error.log",level:"error",format:S})],x=$().createLogger({level:"development"===N?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},transports:_}),D=(0,r.Router)();D.get("/",((e,r)=>{const{amount:o}=e.query;let n=Number(o);n||(n=1e8);const s=(0,U.fork)("./api/utils/getRandomNumbers.js");s.send(n),s.on("message",(e=>{r.end(JSON.stringify(e,null,3))})),s.on("exit",(e=>{x.info("Se ha cerrado el proceso",e)}))}));const M=D,E=(0,r.Router)();E.get("/",((e,r)=>{const o={numberOfProcessors:P().cpus().length,title:process.argv,arguments:process.argv,system:process.platform,version:process.version,memory:process.memoryUsage.rss(),path:process.execPath,id:process.pid,folder:process.cwd()};return console.log(o),r.render("info",o)}));const I=E,j=require("connect-flash");var C=e.n(j);const T=require("cookie-parser");var k=e.n(T);const z=require("passport");var B=e.n(z);const Y=require("compression");var A=e.n(Y);x.info("Informaci√≥n"),x.debug("Debug"),x.warn("Advertencia"),x.error("Error");const G=g.PORT||8081,L=o()();if("CLUSTER"===process.argv[3]&&b().isPrimary){const e=P().cpus().length;x.info(`Number of CPUs: ${e}`),x.info(`Master PID ${process.pid} is running`);for(let r=0;r<e;r++)b().fork();b().on("exit",((e,r,o)=>{x.info(`Worker ${e.process.pid} died`),b().fork()}))}else L.use("/api/randoms",M),L.listen(G,(()=>{x.info(`Server listening on port ${G}.`,`Process ID: ${process.pid}.`)})).on("error",(e=>x.error(`An error has ocurred when starting: ${e}`)));L.use(o().static(f().join(__dirname,"../public"))),L.use(o().json()),L.use(k()()),L.use(o().urlencoded({extended:!0})),L.set("views",f().join(__dirname,"../api/views")),L.set("view engine","ejs");const W={useNewUrlParser:!0,useUnifiedTopology:!0};L.use(s()({store:y().create({mongoUrl:h.mongoDB.URI,mongoOptions:W}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),i().connect(h.mongoDB.URI,W,(e=>{try{x.info("Connected to MongoDB Atlas")}catch(e){x.error(`${e}`)}})),L.use(B().initialize()),L.use(B().session()),L.use(C()()),B().serializeUser(((e,r)=>{r(null,e._id)})),B().deserializeUser(((e,r)=>{return o=void 0,n=void 0,t=function*(){const o=yield p.findById(e);r(null,o)},new((s=void 0)||(s=Promise))((function(e,r){function i(e){try{c(t.next(e))}catch(e){r(e)}}function a(e){try{c(t.throw(e))}catch(e){r(e)}}function c(r){var o;r.done?e(r.value):(o=r.value,o instanceof s?o:new s((function(e){e(o)}))).then(i,a)}c((t=t.apply(o,n||[])).next())}));var o,n,s,t})),L.use("/info",I),L.use("/infoCompressed",A()(),I)})();