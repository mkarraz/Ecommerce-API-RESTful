(()=>{"use strict";var e={514:e=>{e.exports=require("knex")}},r={};function t(o){var n=r[o];if(void 0!==n)return n.exports;var i=r[o]={exports:{}};return e[o](i,i.exports,t),i.exports}t.n=e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},t.d=(e,r)=>{for(var o in r)t.o(r,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:r[o]})},t.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),(()=>{const e=require("express");var r=t.n(e);const o=require("express-session");var n=t.n(o);const i=require("mongoose");var s=t.n(i);const c=require("bcrypt");var a=t.n(c),d=function(e,r,t,o){return new(t||(t=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,c)}a((o=o.apply(e,r||[])).next())}))};const u=new(s().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0}},{collection:"users"});u.pre("save",(function(e){return d(this,void 0,void 0,(function*(){const r=this;if(!r)return e();try{const t=yield a().genSalt(10),o=yield a().hash(r.password,t);r.password=o,e()}catch(r){e(r)}}))})),u.methods.comparePassword=(e,r)=>d(void 0,void 0,void 0,(function*(){return yield a().compareSync(e,r)}));const l=s().model("User",u),m=(__dirname,require("winston"));var f=t.n(m);const h=require("dotenv");var p=t.n(h);p().config();const v=process.env.ENVIRONMENT_MODE||"development";f().addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const g=f().format.combine(f().format.timestamp({format:"DD-MM-YYYY HH:mm:ss:ms"}),f().format.printf((e=>`${e.timestamp} ${e.level}: ${e.message}`))),y=[new(f().transports.Console)({format:f().format.combine(f().format.colorize({all:!0}),g)}),new(f().transports.File)({filename:"logs/warn.log",level:"warn",format:g}),new(f().transports.File)({filename:"logs/error.log",level:"error",format:g})],w=f().createLogger({level:"development"===v?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},transports:y});var b=function(e,r,t,o){return new(t||(t=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,c)}a((o=o.apply(e,r||[])).next())}))};const P=new class{constructor(e,r){this.db=t(514)(e),this.table=r,this.createTableIfNotExists()}createTableIfNotExists(){return b(this,void 0,void 0,(function*(){if(!(yield this.db.schema.hasTable(this.table)))try{yield this.db.schema.createTableIfNotExists(this.table,(e=>{e.increments("id").primary(),e.string("title"),e.integer("price"),e.string("thumbnail"),e.integer("timestamp")}))}catch(e){w.error(`Method: createTableIfNotExists, ${e}`)}}))}getAll(){return b(this,void 0,void 0,(function*(){return yield this.db.select("*").from(this.table)}))}getById(e){return b(this,void 0,void 0,(function*(){try{return(yield this.db.select("*").where("id",e).from(this.table))||{error:"Product not found"}}catch(e){w.error(`Method: getById, ${e}`)}return{error:"Fetch item method failed"}}))}addProduct(e){return b(this,void 0,void 0,(function*(){try{const r=Date.now();yield this.db.insert(Object.assign(Object.assign({},e),{timestamp:r})).into(this.table)}catch(e){w.error(`Method: addProduct, ${e}`)}}))}updateProductById(e,r){return b(this,void 0,void 0,(function*(){try{yield this.db.where("id",e).update({title:r.name,price:r.price,thumbnail:r.photoURL}).from(this.table)}catch(e){w.error(`Method: updateProductById, ${e}`)}}))}deleteProductById(e){return b(this,void 0,void 0,(function*(){try{yield this.db.delete("*").where("id",e).from(this.table)}catch(e){w.error(`Method: deleteProductById, ${e}`)}}))}}({client:"mysql",connection:{host:"127.0.0.1",port:3307,user:"root",password:"",database:"Clase_16"},pool:{min:0,max:7}},"products"),x=require("fs");var q=t.n(x);const O=require("normalizr"),N=(e,r)=>{const t=new O.schema.Entity("author",{},{idAttribute:"userEmail"}),o=new O.schema.Entity("message",{author:t},{idAttribute:"id"}),n=new O.schema.Entity("messages",{messages:[o]},{idAttribute:"id"});return"normalize"==e?(0,O.normalize)({id:"messages",messages:r},n):(0,O.denormalize)(r.result,n,r.entities)},I=require("util");var $=t.n(I),E=function(e,r,t,o){return new(t||(t=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,c)}a((o=o.apply(e,r||[])).next())}))};function S(e){w.info($().inspect(e,!1,12,!0))}const M=new class extends class{constructor(e){this.filePath=e}}{constructor(){super("./DB/chat.json")}readChatFromFile(){return E(this,void 0,void 0,(function*(){try{const e=yield q().promises.readFile(this.filePath,"utf8"),r=JSON.parse(e),t=N("denormalize",r);return w.info("Denormalized"),S(t),t}catch(e){w.error("File cannot be read "+e)}}))}writeChatToFile(e){return E(this,void 0,void 0,(function*(){try{const r=N("normalize",e);w.info("Normalized"),S(r),yield q().promises.writeFile(this.filePath,JSON.stringify(r))}catch(e){w.error("File cannot be written "+e)}}))}},R=require("path");var U=t.n(R);(0,h.config)({path:R.resolve(__dirname,"../../.env")});const T={admin:!0,hostNanme:"http://localhost:8080",PORT:process.argv[2]||parseInt(process.env.PORT)};p().config();const _={mongoDB:{URI:`mongodb+srv://${process.env.MONGOUSR}:${process.env.MONGOPWD}@${process.env.MONGOCLUSTER}.mongodb.net/?retryWrites=true&w=majority`}},z=require("connect-mongo");var D=t.n(z);const C=require("socket.io"),B=require("cluster");var j=t.n(B);const F=require("os");var A=t.n(F);const k=require("child_process"),J=(0,e.Router)();J.get("/",((e,r)=>{const{amount:t}=e.query;let o=Number(t);o||(o=1e8);const n=(0,k.fork)("./api/utils/getRandomNumbers.js");n.send(o),n.on("message",(e=>{r.end(JSON.stringify(e,null,3))})),n.on("exit",(e=>{w.info("Se ha cerrado el proceso",e)}))}));const Y=J,L=(0,e.Router)();L.get("/",((e,r)=>{const t={numberOfProcessors:A().cpus().length,title:process.argv,arguments:process.argv,system:process.platform,version:process.version,memory:process.memoryUsage.rss(),path:process.execPath,id:process.pid,folder:process.cwd()};return console.log(t),r.render("info",t)}));const G=L,W=require("connect-flash");var H=t.n(W);const K=require("cookie-parser");var V=t.n(K);const Q=require("passport");var X=t.n(Q);const Z=require("compression");var ee=t.n(Z),re=function(e,r,t,o){return new(t||(t=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,c)}a((o=o.apply(e,r||[])).next())}))};w.info("Informaci√≥n"),w.debug("Debug"),w.warn("Advertencia"),w.error("Error");const te=T.PORT||8081,oe=r()();if("CLUSTER"===process.argv[3]&&j().isPrimary){const e=A().cpus().length;w.info(`Number of CPUs: ${e}`),w.info(`Master PID ${process.pid} is running`);for(let r=0;r<e;r++)j().fork();j().on("exit",((e,r,t)=>{w.info(`Worker ${e.process.pid} died`),j().fork()}))}else{oe.use("/api/randoms",Y);const e=oe.listen(te,(()=>{w.info(`Server listening on port ${te}.`,`Process ID: ${process.pid}.`)}));e.on("error",(e=>w.error(`An error has ocurred when starting: ${e}`)));const r=new C.Server(e);let t=[];r.on("connection",(e=>re(void 0,void 0,void 0,(function*(){w.info(`New user connected: ${e.id}`),e.emit("server:products",yield P.getAll()),e.emit("server:message",t),e.on("client:product",(e=>re(void 0,void 0,void 0,(function*(){P.addProduct(e),r.emit("server:products",yield P.getAll())})))),e.on("client:message",(e=>re(void 0,void 0,void 0,(function*(){e.id=t.length+1,t.push(e),M.writeChatToFile(t);const o=t,n=N("normalize",t);let i=Math.round(100*(1-JSON.stringify(n).length/JSON.stringify(o).length));w.info("Comnpression Rate: ",i),r.emit("server:message",t)}))))}))))}oe.use(r().static(U().join(__dirname,"../public"))),oe.use(r().json()),oe.use(V()()),oe.use(r().urlencoded({extended:!0})),oe.set("views",U().join(__dirname,"../api/views")),oe.set("view engine","ejs");const ne={useNewUrlParser:!0,useUnifiedTopology:!0};oe.use(n()({store:D().create({mongoUrl:_.mongoDB.URI,mongoOptions:ne}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),s().connect(_.mongoDB.URI,ne,(e=>{try{w.info("Connected to MongoDB Atlas")}catch(e){w.error(`${e}`)}})),oe.use(X().initialize()),oe.use(X().session()),oe.use(H()()),X().serializeUser(((e,r)=>{r(null,e._id)})),X().deserializeUser(((e,r)=>re(void 0,void 0,void 0,(function*(){const t=yield l.findById(e);r(null,t)})))),oe.use("/info",G),oe.use("/infoCompressed",ee()(),G)})()})();