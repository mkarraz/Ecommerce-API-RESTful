(()=>{"use strict";var e={514:e=>{e.exports=require("knex")}},r={};function t(o){var n=r[o];if(void 0!==n)return n.exports;var i=r[o]={exports:{}};return e[o](i,i.exports,t),i.exports}t.n=e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},t.d=(e,r)=>{for(var o in r)t.o(r,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:r[o]})},t.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),(()=>{const e=require("express");var r=t.n(e);const o=require("express-session");var n=t.n(o);const i=require("mongoose");var s=t.n(i);const c=require("bcrypt");var a=t.n(c),d=function(e,r,t,o){return new(t||(t=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,c)}a((o=o.apply(e,r||[])).next())}))};const u=new(s().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0}},{collection:"users"});u.pre("save",(function(e){return d(this,void 0,void 0,(function*(){const r=this;if(!r)return e();try{const t=yield a().genSalt(10),o=yield a().hash(r.password,t);r.password=o,e()}catch(r){e(r)}}))})),u.methods.comparePassword=(e,r)=>d(void 0,void 0,void 0,(function*(){return yield a().compareSync(e,r)}));const l=s().model("User",u),m=(__dirname,require("winston"));var f=t.n(m);const h=require("dotenv");var p=t.n(h);p().config();const v=process.env.ENVIRONMENT_MODE||"development";f().addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const g=f().format.combine(f().format.timestamp({format:"DD-MM-YYYY HH:mm:ss:ms"}),f().format.printf((e=>`${e.timestamp} ${e.level}: ${e.message}`))),y=[new(f().transports.Console)({format:f().format.combine(f().format.colorize({all:!0}),g)}),new(f().transports.File)({filename:"logs/warn.log",level:"warn",format:g}),new(f().transports.File)({filename:"logs/error.log",level:"error",format:g})],w=f().createLogger({level:"development"===v?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},transports:y});var b=function(e,r,t,o){return new(t||(t=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,c)}a((o=o.apply(e,r||[])).next())}))};const x=new class{constructor(e,r){this.db=t(514)(e),this.table=r,this.createTableIfNotExists()}createTableIfNotExists(){return b(this,void 0,void 0,(function*(){if(!(yield this.db.schema.hasTable(this.table)))try{yield this.db.schema.createTableIfNotExists(this.table,(e=>{e.increments("id").primary(),e.string("title"),e.integer("price"),e.string("thumbnail"),e.integer("timestamp")}))}catch(e){w.error(`Method: createTableIfNotExists, ${e}`)}}))}getAll(){return b(this,void 0,void 0,(function*(){return yield this.db.select("*").from(this.table)}))}getById(e){return b(this,void 0,void 0,(function*(){try{return(yield this.db.select("*").where("id",e).from(this.table))||{error:"Product not found"}}catch(e){w.error(`Method: getById, ${e}`)}return{error:"Fetch item method failed"}}))}addProduct(e){return b(this,void 0,void 0,(function*(){try{const r=Date.now();yield this.db.insert(Object.assign(Object.assign({},e),{timestamp:r})).into(this.table)}catch(e){w.error(`Method: addProduct, ${e}`)}}))}updateProductById(e,r){return b(this,void 0,void 0,(function*(){try{yield this.db.where("id",e).update({title:r.name,price:r.price,thumbnail:r.photoURL}).from(this.table)}catch(e){w.error(`Method: updateProductById, ${e}`)}}))}deleteProductById(e){return b(this,void 0,void 0,(function*(){try{yield this.db.delete("*").where("id",e).from(this.table)}catch(e){w.error(`Method: deleteProductById, ${e}`)}}))}}({client:"mysql",connection:{host:"127.0.0.1",port:3307,user:"root",password:"",database:"Clase_16"},pool:{min:0,max:7}},"products"),P=require("fs");var q=t.n(P);const N=require("normalizr"),O=(e,r)=>{const t=new N.schema.Entity("author",{},{idAttribute:"userEmail"}),o=new N.schema.Entity("message",{author:t},{idAttribute:"id"}),n=new N.schema.Entity("messages",{messages:[o]},{idAttribute:"id"});return"normalize"==e?(0,N.normalize)({id:"messages",messages:r},n):(0,N.denormalize)(r.result,n,r.entities)},$=require("util");var I=t.n($),E=function(e,r,t,o){return new(t||(t=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,c)}a((o=o.apply(e,r||[])).next())}))};function S(e){w.info(I().inspect(e,!1,12,!0))}const M=new class extends class{constructor(e){this.filePath=e}}{constructor(){super("./DB/chat.json")}readChatFromFile(){return E(this,void 0,void 0,(function*(){try{const e=yield q().promises.readFile(this.filePath,"utf8"),r=JSON.parse(e),t=O("denormalize",r);return w.info("Denormalized"),S(t),t}catch(e){w.error("File cannot be read "+e)}}))}writeChatToFile(e){return E(this,void 0,void 0,(function*(){try{const r=O("normalize",e);w.info("Normalized"),S(r),yield q().promises.writeFile(this.filePath,JSON.stringify(r))}catch(e){w.error("File cannot be written "+e)}}))}};p().config();const U={mongoDB:{URI:`mongodb+srv://${process.env.MONGOUSR}:${process.env.MONGOPWD}@${process.env.MONGOCLUSTER}.mongodb.net/?retryWrites=true&w=majority`}},z=require("connect-mongo");var D=t.n(z);const R=require("socket.io"),C=require("cluster");var T=t.n(C);const _=require("os");var B=t.n(_);const j=require("child_process"),F=(0,e.Router)();F.get("/",((e,r)=>{const{amount:t}=e.query;let o=Number(t);o||(o=1e8);const n=(0,j.fork)("./api/utils/getRandomNumbers.js");n.send(o),n.on("message",(e=>{r.end(JSON.stringify(e,null,3))})),n.on("exit",(e=>{w.info("Se ha cerrado el proceso",e)}))}));const A=F,k=(0,e.Router)();k.get("/",((e,r)=>{const t={numberOfProcessors:B().cpus().length,title:process.argv,arguments:process.argv,system:process.platform,version:process.version,memory:process.memoryUsage.rss(),path:process.execPath,id:process.pid,folder:process.cwd()};return console.log(t),r.render("info",t)}));const J=k,Y=require("connect-flash");var L=t.n(Y);const G=require("cookie-parser");var W=t.n(G);const H=require("passport");var K=t.n(H);const V=require("path");var Q=t.n(V);const X=require("compression");var Z=t.n(X),ee=function(e,r,t,o){return new(t||(t=Promise))((function(n,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,c)}a((o=o.apply(e,r||[])).next())}))};w.info("Informaci√≥n"),w.debug("Debug"),w.warn("Advertencia"),w.error("Error");const re=process.env.PORT||8081,te=r()();if("CLUSTER"===process.argv[3]&&T().isPrimary){const e=B().cpus().length;w.info(`Number of CPUs: ${e}`),w.info(`Master PID ${process.pid} is running`);for(let r=0;r<e;r++)T().fork();T().on("exit",((e,r,t)=>{w.info(`Worker ${e.process.pid} died`),T().fork()}))}else{te.use("/api/randoms",A);const e=te.listen(re,(()=>{w.info(`Server listening on port ${re}.`,`Process ID: ${process.pid}.`)}));e.on("error",(e=>w.error(`An error has ocurred when starting: ${e}`)));const r=new R.Server(e);let t=[];r.on("connection",(e=>ee(void 0,void 0,void 0,(function*(){w.info(`New user connected: ${e.id}`),e.emit("server:products",yield x.getAll()),e.emit("server:message",t),e.on("client:product",(e=>ee(void 0,void 0,void 0,(function*(){x.addProduct(e),r.emit("server:products",yield x.getAll())})))),e.on("client:message",(e=>ee(void 0,void 0,void 0,(function*(){e.id=t.length+1,t.push(e),M.writeChatToFile(t);const o=t,n=O("normalize",t);let i=Math.round(100*(1-JSON.stringify(n).length/JSON.stringify(o).length));w.info("Comnpression Rate: ",i),r.emit("server:message",t)}))))}))))}te.use(r().static(Q().join(__dirname,"../public"))),te.use(r().json()),te.use(W()()),te.use(r().urlencoded({extended:!0})),te.set("views",Q().join(__dirname,"../api/views")),te.set("view engine","ejs");const oe={useNewUrlParser:!0,useUnifiedTopology:!0};te.use(n()({store:D().create({mongoUrl:U.mongoDB.URI,mongoOptions:oe}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),s().connect(U.mongoDB.URI,oe,(e=>{try{w.info("Connected to MongoDB Atlas")}catch(e){w.error(`${e}`)}})),te.use(K().initialize()),te.use(K().session()),te.use(L()()),K().serializeUser(((e,r)=>{r(null,e._id)})),K().deserializeUser(((e,r)=>ee(void 0,void 0,void 0,(function*(){const t=yield l.findById(e);r(null,t)})))),te.use("/info",J),te.use("/infoCompressed",Z()(),J)})()})();