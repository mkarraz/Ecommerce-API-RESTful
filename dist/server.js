(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=require("express");var r=e.n(t);const n=require("express-session");var o=e.n(n);const i=require("dotenv");var d=e.n(i);d().config();const s={MONGO_ATLAS_URL:`mongodb+srv://${process.env.MONGO_USR}:${process.env.MONGO_PWD}@${process.env.MONGO_CLUSTER}.mongodb.net/?retryWrites=true&w=majority`,PERSISTENCE:process.argv[4]||process.env.PERSISTENCE||3},c=require("connect-mongo");var u=e.n(c);const a=require("mongoose");var l=e.n(a);const h=new(l().Schema)({name:{type:String,required:!0,minlength:1,maxlength:50},price:{type:Number,required:!0,min:0},description:{type:String,required:!0,minlength:1,maxlength:200},photoURL:{type:String,required:!0,minlength:1,maxlength:200},stock:{type:Number,required:!0,min:0},timestamp:{type:String,required:!1,default:(new Date).toLocaleString()}}),f=l().model("products",h);var p=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const v=require("winston");var m=e.n(v);d().config();const y=process.env.ENVIRONMENT_MODE||"development";m().addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const w=m().format.combine(m().format.timestamp({format:"DD-MM-YYYY HH:mm:ss:ms"}),m().format.printf((e=>`${e.timestamp} ${e.level}: ${e.message}`))),g=[new(m().transports.Console)({format:m().format.combine(m().format.colorize({all:!0}),w)}),new(m().transports.File)({filename:"logs/warn.log",level:"warn",format:w}),new(m().transports.File)({filename:"logs/error.log",level:"error",format:w})],P=m().createLogger({level:"development"===y?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},transports:g});const I=()=>{return e=void 0,t=void 0,n=function*(){try{yield l().connect(s.MONGO_ATLAS_URL),P.info("Connected to mongoDB Atlas!")}catch(e){P.error(e)}},new((r=void 0)||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}));var e,t,r,n};var C,B,$,b,A,S,E,T=function(e,t,r,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?o.call(e,r):o?o.value=r:t.set(e,r),r},O=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};C=new WeakMap,B=new WeakMap,$=new WeakMap,b=new WeakMap,A=new WeakMap,S=new WeakMap,E=new WeakMap;var q=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const x=l().Types.ObjectId;class M extends class{constructor(){}getById(e){return p(this,void 0,void 0,(function*(){throw new Error("Product - getById not Implemented")}))}getAll(){return p(this,void 0,void 0,(function*(){throw new Error("Product - getAll not Implemented")}))}addProduct(e){return p(this,void 0,void 0,(function*(){throw new Error("Product - addProduct not Implemented")}))}updateProductById(e,t){return p(this,void 0,void 0,(function*(){throw new Error("Product - updateProductById not Implemented")}))}deleteProductById(e){return p(this,void 0,void 0,(function*(){throw new Error("Product - deleteProductById not Implemented")}))}}{constructor(e,t){super(),this.model=e,this.DTO=t,I()}static getInstance(e,t){return this.instance||(this.instance=new M(e,t)),this.instance}getAll(){return q(this,void 0,void 0,(function*(){try{return(yield this.model.find()).map((e=>new this.DTO(e).toJson()))}catch(e){P.error(`MongoAtlas getAll method error: ${e}`)}}))}getById(e){return q(this,void 0,void 0,(function*(){try{if(!x.isValid(e))return;const t=yield this.model.findById(e);return t?new this.DTO(t).toJson():null}catch(e){P.error(`MongoAtlas getById method error: ${e}`)}}))}addProduct(e){return q(this,void 0,void 0,(function*(){try{const t=new this.model(e),r=yield t.save();return new this.DTO(r).toJson()}catch(e){P.error(`MongoAtlas addProduct method error: ${e}`)}}))}updateProductById(e,t){return q(this,void 0,void 0,(function*(){try{return 0===(yield this.model.updateOne({_id:e},t)).matchedCount?{error:"Product not found."}:this.getById(e)}catch(e){P.error(`MongoAtlas updateProductById method error: ${e}`)}}))}deleteProductById(e){return q(this,void 0,void 0,(function*(){try{const t=yield this.getById(e);if(!t)return;return yield this.model.deleteOne({_id:e}),t}catch(e){P.error(`MongoAtlas deleteProductById method error: ${e}`)}}))}}const U=M.getInstance(f,class{constructor(e){C.set(this,void 0),B.set(this,void 0),$.set(this,void 0),b.set(this,void 0),A.set(this,void 0),S.set(this,void 0),E.set(this,void 0),T(this,C,e._id,"f"),T(this,B,e.name,"f"),T(this,$,e.price,"f"),T(this,b,e.description,"f"),T(this,A,e.photoURL,"f"),T(this,S,e.stock,"f"),T(this,E,e.timestamp,"f")}getId(){return O(this,C,"f")}getName(){return O(this,B,"f")}getPrice(){return O(this,$,"f")}getDescription(){return O(this,b,"f")}getPhotoURL(){return O(this,A,"f")}getStock(){return O(this,S,"f")}getTimestamp(){return O(this,E,"f")}toJson(){return{id:O(this,C,"f"),name:O(this,B,"f"),price:O(this,$,"f"),description:O(this,b,"f"),photoURL:O(this,A,"f"),stock:O(this,S,"f"),timestamp:O(this,E,"f")}}}),N=new(l().Schema)({products:[{type:Object,required:!0,ref:"products"}],user:{type:String,required:!0},timestamp:{type:Number,required:!0,default:Date.now}}),D=l().model("carts",N);var _=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};var R,j,L,k,W=function(e,t,r,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?o.call(e,r):o?o.value=r:t.set(e,r),r},F=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};R=new WeakMap,j=new WeakMap,L=new WeakMap,k=new WeakMap;var G=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const J=new class extends class{constructor(){}createNewCart(e){return _(this,void 0,void 0,(function*(){throw new Error("Cart - createNewCart not Implemented")}))}cartProdDeleteById(e){return _(this,void 0,void 0,(function*(){throw new Error("Cart - cartProdDeleteById not Implemented")}))}addToCartById(e,t){return _(this,void 0,void 0,(function*(){throw new Error("Cart - addToCartById not Implemented")}))}getProductsByCartId(e){return _(this,void 0,void 0,(function*(){throw new Error("Cart - getProductsByCartId not Implemented")}))}deleteProductByCartId(e,t){return _(this,void 0,void 0,(function*(){throw new Error("Cart - deleteProductByCartId not Implemented")}))}}{constructor(e,t){super(),this.model=e,this.DTO=t,I()}createNewCart(e){return G(this,void 0,void 0,(function*(){const t=new this.model({user:{id:e.id,username:e.email},products:[]}),r=yield t.save();return new this.DTO(r).toJson()}))}cartProdDeleteById(e){return G(this,void 0,void 0,(function*(){const t=yield this.model.findOne({user:e.id});if(null===t)return{error:"Cart not found in cartProdDeleteById method"};0===(yield this.model.updateOne({_id:t._id},{$set:{products:[]}})).modifiedCount?P.error("Products not deleted from cart"):P.info("Products deleted from cart")}))}addToCartById(e,t){return G(this,void 0,void 0,(function*(){const r=yield this.model.findOne({user:e._id});if(null===r)P.error("Cart not found in addToCartById method.");else{if(0!==(yield this.model.updateOne({_id:r._id},{$push:{products:t}})).modifiedCount)return P.info("Product succesfully added to cart!"),r;P.error("Product not added to cart.")}}))}getProductsByCartId(e){return G(this,void 0,void 0,(function*(){const t=yield this.model.findOne({user:e.id});return null===t?{error:"Cart not found"}:new this.DTO(t).toJson()}))}deleteProductByCartId(e,t){return G(this,void 0,void 0,(function*(){P.info(`prod: ${t}`);const r=yield this.model.findOne({user:e.id});if(P.info(`cart: ${r}`),null===r)return{error:"Cart not found"};0===(yield this.model.updateOne({_id:r._id},{$pull:{products:{id:t.id}}})).modifiedCount?P.error("Product not deleted from cart"):P.info("Product succesfully deleted from cart!")}))}}(D,class{constructor(e){R.set(this,void 0),j.set(this,void 0),L.set(this,void 0),k.set(this,void 0),W(this,R,e._id,"f"),W(this,j,e.products,"f"),W(this,L,e.user,"f"),W(this,k,e.timestamp,"f")}getId(){return F(this,R,"f")}getProducts(){return{product:F(this,j,"f")}}getUserId(){return F(this,L,"f")}getTimestamp(){return F(this,k,"f")}toJson(){return[F(this,R,"f"),F(this,j,"f"),F(this,L,"f"),F(this,k,"f")][1]}}),V=new(l().Schema)({products:[{type:Object,required:!0,ref:"products"}],user:{type:String,required:!0},timestamp:{type:Number,required:!0,default:Date.now},status:{type:String,default:"generada"},number:{type:Number,default:0}}),Y=l().model("orders",V);var z,H,K,Q,X,Z=function(e,t,r,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?o.call(e,r):o?o.value=r:t.set(e,r),r},ee=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};z=new WeakMap,H=new WeakMap,K=new WeakMap,Q=new WeakMap,X=new WeakMap;const te=l().Types.ObjectId,re=new class{constructor(e,t,r){this.cartModel=e,this.orderModel=t,this.DTO=r,I()}createOrder(e){return t=this,r=void 0,o=function*(){if(te.isValid(e.id))try{const t=yield this.cartModel.find({user:e.id}).populate({path:"products",select:"_id title description code thumbnail price"}).exec();if(P.info(`cartProducts, ${t}`),0==t.length)throw new Error("There is not products in the cart.");const r=t.map((e=>Object.assign(Object.assign({},e.product),{quantity:e.quantity})));P.info(`products, ${r}`);const n=yield this.orderModel.create({user:e.id,products:r,number:yield this.orderModel.countDocuments({})});P.info(`newOrder, ${n}`);const o=new this.DTO(n).toJson();return P.info(`data, ${o}`),o}catch(e){P.error(`MongoAtlas getAll method error: ${e}`)}},new((n=void 0)||(n=Promise))((function(e,i){function d(e){try{c(o.next(e))}catch(e){i(e)}}function s(e){try{c(o.throw(e))}catch(e){i(e)}}function c(t){var r;t.done?e(t.value):(r=t.value,r instanceof n?r:new n((function(e){e(r)}))).then(d,s)}c((o=o.apply(t,r||[])).next())}));var t,r,n,o}}(D,Y,class{constructor(e){z.set(this,void 0),H.set(this,void 0),K.set(this,void 0),Q.set(this,void 0),X.set(this,void 0),Z(this,z,e._id,"f"),Z(this,H,e.timestamp,"f"),Z(this,K,e.user,"f"),Z(this,Q,e.products,"f"),Z(this,X,e.status,"f")}getId(){return ee(this,z,"f")}getProducts(){return{product:ee(this,Q,"f")}}getUser(){return ee(this,K,"f")}getTimestamp(){return ee(this,H,"f")}getStatus(){return ee(this,X,"f")}toJson(){return{id:ee(this,z,"f"),timestamp:ee(this,H,"f"),user:ee(this,K,"f"),products:ee(this,Q,"f"),status:ee(this,X,"f")}}}),ne=s.PERSISTENCE,oe=e=>class{static getPersistence(e,t){try{if("products"===t)return U;if("cart"===t)return J;if("order"===t)return re;throw new Error("Persistence not found")}catch(e){console.log(e),P.error("Persistence type not found")}}}.getPersistence(ne,e);var ie=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const de=oe("products"),se=new class{constructor(e){this.model=e}getAllProducts(){return ie(this,void 0,void 0,(function*(){return yield this.model.getAll()}))}getProductById(e){return ie(this,void 0,void 0,(function*(){return yield this.model.getById(e)}))}addProduct(e){return ie(this,void 0,void 0,(function*(){return yield this.model.addProduct(e)}))}updateProductById(e,t){return ie(this,void 0,void 0,(function*(){return yield this.model.updateProductById(e,t)}))}deleteProductById(e){return ie(this,void 0,void 0,(function*(){return yield this.model.deleteProductById(e)}))}}(de);var ce=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const ue=new class{constructor(){}getAll(e,t){return ce(this,void 0,void 0,(function*(){P.info(`${e.method} request to '${e.originalUrl}' route: Getting all products from DB`);try{const e=yield se.getAllProducts();return t.status(200).json({products:e})}catch(e){return P.error(`Error in getAll method: ${e}`),t.status(500).json({error:"An error has occurred."})}}))}getById(e,t){return ce(this,void 0,void 0,(function*(){P.info(`${e.method} request to '${e.originalUrl}' route: Getting product by id from DB`);try{const{id:r}=e.params,n=yield se.getProductById(r);return null==n?t.status(404).json({error:"Cannot find requested product"}):t.status(200).json({product:n})}catch(e){return P.error(`Error in getById method: ${e}`),t.status(500).json({error:"An error has occurred."})}}))}addProduct(e,t){return ce(this,void 0,void 0,(function*(){P.info(`${e.method} request to '${e.originalUrl}' route: Adding new product to DB`);try{const r=e.body,n=yield se.addProduct(r);return t.status(200).json({ProductAdded:n})}catch(e){return P.error(`Error in addProduct method: ${e}`),t.status(500).json({error:"An error has occurred."})}}))}updateProductById(e,t){return ce(this,void 0,void 0,(function*(){P.info(`${e.method} request to '${e.originalUrl}' route: Updating product at DB`);try{const{id:r}=e.params,n=e.body,o=yield se.updateProductById(r,n);return null==o?t.status(404).json({error:"Cannot find requested product"}):t.status(200).json({ProductUpdated:o})}catch(e){return P.error(`Error in updateProductById method: ${e}`),t.status(500).json({error:"An error has occurred."})}}))}deleteProductById(e,t){return ce(this,void 0,void 0,(function*(){P.info(`${e.method} request to '${e.originalUrl}' route: Deleting product by id from DB`);try{const{id:r}=e.params,n=yield se.deleteProductById(r);return null==n?t.status(404).json({error:"Cannot find requested product"}):t.status(200).json({ProductDeleted:n})}catch(e){P.error(`Error in deleteProductById method: ${e}`)}}))}},ae=require("nodemailer");var le=e.n(ae),he=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};d().config();const fe=le().createTransport({service:"gmail",auth:{user:process.env.GMAIL_MAIL,pass:process.env.GMAIL_PROVISIONAL_PASS}}),pe=new class{constructor(){this.transporter=fe}newRegister(e){return he(this,void 0,void 0,(function*(){try{yield this.transporter.sendMail({from:"E-commerce MK",to:process.env.GMAIL_MAIL,subject:"New registered user",html:` \n                        <h1>A new user has been registered!</h1>\n                        <br>\n                        <p>Name: ${e.name}</p> \n                        <p>eMail: ${e.email}</p>\n                        <p>Address: ${e.address}</p>   \n                        <p>Age: ${e.age}</p>\n                        <p>Phone Number: ${e.phoneNumber}</p>`})}catch(t){P.error(`An error has occurred when sending the user registration email: ${e.email}`)}}))}newOrder(e,t){return he(this,void 0,void 0,(function*(){try{yield this.transporter.sendMail({from:"E-commerce MK",to:process.env.GMAIL_MAIL,subject:`New order from ${e.name}`,html:`\n                    <h5> User: </h5>\n                        <p>${e.name}</p> \n                        <p>${e.email}</p> \n                        <p>${e.phoneNumber}</p>\n                        </hr>\n            \n                        <h2> Pedido </h2>\n                        <table>\n                            <thead>\n                                <tr>\n                                    <th scope="col">Name</th>\n                                    <th scope="col">Price</th>\n                                    <th scope="col">Description</th>\n                                    <th scope="col">Thumbnail</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                ${t.map((e=>`<tr>\n                                    <td>${e.name}</td>\n                                    <td>${e.price}</td>\n                                    <td>${e.description}</td>\n                                    <td><img style="max-width: 40px" src="${e.photoURL}"></img></td>\n                                </tr>`))}\n                            </tbody>\n                        </table>\n                        `})}catch(t){P.error(`An error has occurred when sending the user registration email: ${e.email}`)}}))}},ve=require("twilio");var me=e.n(ve),ye=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};d().config();const we=process.env.TWILIO_ACCOUNTSID,ge=process.env.TWILIO_AUTH_TOKEN,Pe=me()(we,ge),Ie=new class{newSMS(e){return ye(this,void 0,void 0,(function*(){try{yield Pe.messages.create({body:"Your order has been received and is being process",from:process.env.TWILIO_NUMBER,to:e.phoneNumber})}catch(t){P.error(`An error has occurred when sending SMS: ${e.email}`)}}))}newWhatsapp(e){return ye(this,void 0,void 0,(function*(){try{yield Pe.messages.create({body:`New order from ${e.name} - ${e.email}`,from:`whatsapp:${process.env.TWILIO_WHATSAPP}`,to:`whatsapp:${process.env.TWILIO_ADMIN_NUMBER}`})}catch(e){P.error("An error has occurred when sending a Whatsapp message")}}))}};var Ce=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const Be=oe("cart"),$e=new class{constructor(e){this.model=e}createNewCart(e){return Ce(this,void 0,void 0,(function*(){return yield this.model.createNewCart(e)}))}cartProdDeleteById(e){return Ce(this,void 0,void 0,(function*(){return yield this.model.cartProdDeleteById(e)}))}getProductsByCartId(e){return Ce(this,void 0,void 0,(function*(){return yield this.model.getProductsByCartId(e)}))}addToCartById(e,t){return Ce(this,void 0,void 0,(function*(){return yield this.model.addToCartById(e,t)}))}deleteProductByCartId(e,t){return Ce(this,void 0,void 0,(function*(){return yield this.model.deleteProductByCartId(e,t)}))}}(Be);var be=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const Ae=new class{constructor(){}cartCreate(e,t){return be(this,void 0,void 0,(function*(){try{yield $e.createNewCart(t),P.info(`Cart created for user ${t.email}`)}catch(t){return P.error(`Error in cartCreate method: ${t}`),e.status(500).json({error:"An error has occurred."})}}))}deleteCartProducts(e,t){return be(this,void 0,void 0,(function*(){try{const r=e.user;yield $e.cartProdDeleteById(r),t.redirect("/api/cart")}catch(e){P.error(`Error in cartProdDeleteById method: ${e}`)}}))}getProductsByCartId(e,t){return be(this,void 0,void 0,(function*(){P.info(`${e.method} request to '${e.originalUrl}' route: Getting products by Cart ID.`);try{const r=e.user,n=yield $e.getProductsByCartId(r);t.render("cart",{products:n,user:r})}catch(e){P.error(`Error in getProductsByCartId method: ${e}`)}}))}addToCartById(e,t){return be(this,void 0,void 0,(function*(){try{const r=e.user,n=e.body;yield $e.addToCartById(r,n),t.redirect("/api/cart")}catch(e){P.error(`Error in addToCartById method: ${e}`)}}))}deleteProductByCartId(e,t){return be(this,void 0,void 0,(function*(){try{const r=e.user,n=e.body;yield $e.deleteProductByCartId(r,n),t.redirect("/api/cart")}catch(e){P.error(`Error in deleteProductByCartId method: ${e}`)}}))}cartOrder(e,t){return be(this,void 0,void 0,(function*(){try{const r=e.user,n=yield $e.getProductsByCartId(r);pe.newOrder(r,n),Ie.newSMS(r),Ie.newWhatsapp(r),t.redirect("/")}catch(e){P.error(`Error in getProductsByCartId method: ${e}`)}}))}};var Se=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const Ee=new class{constructor(){}login(e,t,r){return Se(this,void 0,void 0,(function*(){try{e.isAuthenticated()&&r()}catch(e){P.error(`Error when login method in SessionControllers, ${e}`)}}))}renderLogin(e,t){return Se(this,void 0,void 0,(function*(){e.isAuthenticated()?t.redirect("/"):t.render("login")}))}logout(e,t){return Se(this,void 0,void 0,(function*(){if(e.isAuthenticated()){const r=e.user;e.session.destroy((()=>{t.render("logout",{user:r})}))}else t.redirect("/")}))}renderSignUp(e,t){return Se(this,void 0,void 0,(function*(){e.isAuthenticated()?t.redirect("/"):t.render("signup")}))}signUp(e,t,r){return Se(this,void 0,void 0,(function*(){const r=e.user;t.status(201).render("createdUser",{user:r}),pe.newRegister(r)}))}renderFailedSignup(e,t){return Se(this,void 0,void 0,(function*(){t.status(409).render("failedSignup",{message:e.flash("error")[0]})}))}renderFailedLogin(e,t){return Se(this,void 0,void 0,(function*(){t.status(401).render("failedLogin",{message:e.flash("error")[0]})}))}renderHome(e,t){return Se(this,void 0,void 0,(function*(){t.render("home",{user:e.user})}))}renderUpload(e,t){return Se(this,void 0,void 0,(function*(){e.isAuthenticated()?t.render("upload"):t.render("login")}))}uploadSuccess(e,t,r){return Se(this,void 0,void 0,(function*(){t.status(201).render("uploadSuccess"),r()}))}renderAddProdFormView(e,t){return Se(this,void 0,void 0,(function*(){P.info(`${e.method} request to '${e.originalUrl}' route: Rendering add product form page.`);try{const r=e.user;t.status(200).render("products/addProdForm",{user:r})}catch(e){P.error(e)}}))}};const Te=oe("order"),Oe=new class{constructor(e){this.model=e}getProductsByCartId(e){return t=this,r=void 0,o=function*(){const t=yield this.model.getProductsByCartId(e);return yield this.model.cartProdDeleteById(e),yield pe.newOrder(e,t),yield Ie.newSMS(e),yield Ie.newWhatsapp(e),t},new((n=void 0)||(n=Promise))((function(e,i){function d(e){try{c(o.next(e))}catch(e){i(e)}}function s(e){try{c(o.throw(e))}catch(e){i(e)}}function c(t){var r;t.done?e(t.value):(r=t.value,r instanceof n?r:new n((function(e){e(r)}))).then(d,s)}c((o=o.apply(t,r||[])).next())}));var t,r,n,o}}(Te);const qe=new class{constructor(){}createOrder(e,t){return r=this,n=void 0,i=function*(){try{const r=e.user;yield Oe.getProductsByCartId(r),t.redirect("/")}catch(e){P.error(`Error in getProductsByCartId method, Order Controller: ${e}`)}},new((o=void 0)||(o=Promise))((function(e,t){function d(e){try{c(i.next(e))}catch(e){t(e)}}function s(e){try{c(i.throw(e))}catch(e){t(e)}}function c(t){var r;t.done?e(t.value):(r=t.value,r instanceof o?r:new o((function(e){e(r)}))).then(d,s)}c((i=i.apply(r,n||[])).next())}));var r,n,o,i}},xe=(0,t.Router)();xe.route("/").get(ue.getAll).post(ue.addProduct),xe.route("/:id").get(ue.getById).put(ue.updateProductById).delete(ue.deleteProductById);const Me=xe,Ue=(0,t.Router)();Ue.route("/").post(Ae.cartCreate).get(Ae.getProductsByCartId),Ue.route("/delete").post(Ae.deleteCartProducts),Ue.route("/addProduct").post(Ae.addToCartById),Ue.route("/deleteProduct").post(Ae.deleteProductByCartId);const Ne=Ue,De=(0,t.Router)();De.route("/").post(qe.createOrder);const _e=De,Re=(e,t,r)=>{try{return e.isAuthenticated()?r():t.render("unauthorized")}catch(e){P.error(`Error has occured when checkUserAuth method, ${e}`)}};const je=(0,t.Router)();je.get("/",Re,((e,t)=>{return r=void 0,n=void 0,i=function*(){const r=yield ue.getAll(e,t);t.render("home",{logged:!0,user:e.user,products:r})},new((o=void 0)||(o=Promise))((function(e,t){function d(e){try{c(i.next(e))}catch(e){t(e)}}function s(e){try{c(i.throw(e))}catch(e){t(e)}}function c(t){var r;t.done?e(t.value):(r=t.value,r instanceof o?r:new o((function(e){e(r)}))).then(d,s)}c((i=i.apply(r,n||[])).next())}));var r,n,o,i})),je.route("/addProdForm").get(((e,t,r)=>{const n=e.user;try{return"true"===n.isAdmin?r():t.json({error:"No tiene Permiso",descripcion:`You do not have permission to access to ${e.originalUrl}`,code:"403"})}catch(e){P.error(`Error has occured when checkUserAuth method, ${e}`)}}),Ee.renderAddProdFormView);const Le=je,ke=require("passport");var We=e.n(ke);const Fe=(0,t.Router)();Fe.get("/",Ee.renderLogin),Fe.post("/",We().authenticate("login",{failureRedirect:"/login/failed",failureFlash:!0}),Ee.login),Fe.get("/failed",Ee.renderFailedLogin);const Ge=(0,t.Router)();Ge.post("/",Ee.logout);const Je=require("bcrypt");var Ve=e.n(Je),Ye=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const ze=new(l().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0},name:{type:String,required:!0},address:{type:String,required:!0},age:{type:Number,required:!0},phoneNumber:{type:String,required:!0},picture:{type:String,required:!0},isAdmin:{type:String,required:!0}},{collection:"users"});ze.pre("save",(function(e){return Ye(this,void 0,void 0,(function*(){const t=this;if(!t)return e();try{const r=yield Ve().genSalt(10),n=yield Ve().hash(t.password,r);t.password=n,e()}catch(t){e(t)}}))})),ze.post("save",(function(e){return Ye(this,void 0,void 0,(function*(){try{const t={id:this.id,email:this.email};yield Ae.cartCreate(e,t)}catch(e){P.error(`Error trying to update user cartId: ${e}`)}}))})),ze.methods.comparePassword=(e,t)=>Ye(void 0,void 0,void 0,(function*(){return yield Ve().compareSync(e,t)}));const He=l().model("User",ze),Ke=require("multer");var Qe=e.n(Ke);const Xe=Qe().diskStorage({destination:function(e,t,r){r(null,"uploads")},filename:function(e,t,r){r(null,`${Date.now()}-${t.originalname}`)}}),Ze=Qe()({storage:Xe});const et=(0,t.Router)();et.get("/",Ee.renderSignUp),et.post("/",We().authenticate("signup",{failureRedirect:"/signup/failed",failureFlash:!0}),Ee.signUp),et.get("/upload",Ee.renderUpload),et.post("/upload",Ze.single("picture"),((e,t,r)=>{return n=void 0,o=void 0,d=function*(){const t=e.file;if(!t)return r({message:"Error when uploading file.",statusCode:400});const n={email:e.user.email,password:e.user.password,name:e.user.name,address:e.user.address,age:e.user.age,phoneNumber:e.user.phoneNumber,picture:`${t.filename}`,isAdmin:e.user.isAdmin};try{if(0===(yield He.updateOne({_id:e.user.id},n)).matchedCount)return r({message:"User not found",statusCode:400})}catch(e){P.error(`Error trying to update users avatar: ${e}`)}r()},new((i=void 0)||(i=Promise))((function(e,t){function r(e){try{c(d.next(e))}catch(e){t(e)}}function s(e){try{c(d.throw(e))}catch(e){t(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,s)}c((d=d.apply(n,o||[])).next())}));var n,o,i,d}),Ee.uploadSuccess),et.get("/failed",Ee.renderFailedSignup);const tt=(0,t.Router)();tt.use("/login",Fe),tt.use("/logout",Ge),tt.use("/signup",et),tt.use("/views",Le),tt.use("/api/products",Me),tt.use("/api/cart",Ne),tt.use("/order",_e),tt.use("/",Re,((e,t)=>{return r=void 0,n=void 0,i=function*(){return t.redirect("/views")},new((o=void 0)||(o=Promise))((function(e,t){function d(e){try{c(i.next(e))}catch(e){t(e)}}function s(e){try{c(i.throw(e))}catch(e){t(e)}}function c(t){var r;t.done?e(t.value):(r=t.value,r instanceof o?r:new o((function(e){e(r)}))).then(d,s)}c((i=i.apply(r,n||[])).next())}));var r,n,o,i}));const rt=tt,nt=require("cluster");var ot=e.n(nt);const it=require("os");var dt=e.n(it);const st=require("connect-flash");var ct=e.n(st);const ut=require("cookie-parser");var at=e.n(ut);const lt=require("passport-local");var ht=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const ft=require("path");var pt=e.n(ft);const vt=require("express-graphql"),mt=(0,require("graphql").buildSchema)("\n\n    input ProductInput {\n        name: String,\n        price: Int,\n        description: String,\n        photoURL: String,\n        stock: Int\n    }\n    type Product {\n        id: ID!,\n        name: String!,\n        price: Int!,\n        description: String,\n        photoURL: String,\n        stock: Int\n    }\n    type Query {\n        getProduct(id: ID!): Product,\n        getProducts(key: String, value: String): [Product],\n    }\n    type Mutation {\n        createProduct(data: ProductInput): Product,\n        updateProduct(id: ID!, data: ProductInput): Product,\n        deleteProduct(id: ID!): Product,\n    }\n");var yt=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function d(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}c((n=n.apply(e,t||[])).next())}))};const wt={createProduct:({data:e})=>yt(void 0,void 0,void 0,(function*(){return yield se.addProduct(e)})),getProduct:({id:e})=>yt(void 0,void 0,void 0,(function*(){const t=yield se.getProductById(e);if(!t)throw new Error("Cannot find requested product");return t})),getProducts:({key:e,value:t})=>yt(void 0,void 0,void 0,(function*(){const r=yield se.getAllProducts();return e&&t?r.filter((r=>r[e]==t)):r})),updateProduct:({id:e,data:t})=>yt(void 0,void 0,void 0,(function*(){const r=yield se.updateProductById(e,t);if(null==r)throw new Error("Cannot find requested product");return r})),deleteProduct:({id:e})=>yt(void 0,void 0,void 0,(function*(){const t=yield se.deleteProductById(e);if(null==t)throw new Error("Cannot find requested product");return t}))},gt=process.env.PORT||8081,Pt=r()();if("CLUSTER"===process.argv[3]&&ot().isPrimary){const e=dt().cpus().length;P.info(`Number of CPUs: ${e}`),P.info(`Master PID ${process.pid} is running`);for(let t=0;t<e;t++)ot().fork();ot().on("exit",((e,t,r)=>{P.info(`Worker ${e.process.pid} died`),ot().fork()}))}else Pt.listen(gt,(()=>{P.info(`Server listening on port ${gt}.`,`Process ID: ${process.pid}.`)})).on("error",(e=>P.error(`An error has ocurred when starting: ${e}`)));Pt.use(r().static(pt().join(__dirname,"../uploads"))),Pt.use(r().json()),Pt.use(at()()),Pt.use(r().urlencoded({extended:!0})),Pt.set("views",pt().join(__dirname,"../api/views")),Pt.set("view engine","ejs"),Pt.use(o()({store:u().create({mongoUrl:s.MONGO_ATLAS_URL,mongoOptions:{useNewUrlParser:!0,useUnifiedTopology:!0}}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),Pt.use(We().initialize()),Pt.use(We().session()),Pt.use(ct()()),function(e){e.use("login",new lt.Strategy({usernameField:"email",passwordField:"password"},((e,t,r)=>ht(this,void 0,void 0,(function*(){try{const n=yield He.findOne({email:e}).exec();return n?(yield n.comparePassword(t,n.password))?(P.info(n),r(null,n)):r(null,!1,{message:"Wrong password"}):r(null,!1,{message:"User doesn't exist"})}catch(e){r(e)}}))))),e.use("signup",new lt.Strategy({passReqToCallback:!0,usernameField:"email"},((e,t,r,n)=>ht(this,void 0,void 0,(function*(){const o=new He({email:t,password:r,name:e.body.name,address:e.body.address,age:e.body.age,phoneNumber:`+54${e.body.phoneNumber}`,picture:"avatar.png",isAdmin:"false",cartId:"empty"});try{return yield o.save(),n(null,o)}catch(e){return 11e3===e.code?n(null,!1,{message:"User already exists"}):(P.error(e),n(e))}}))))),e.serializeUser(((e,t)=>{t(null,e._id)})),e.deserializeUser(((e,t)=>ht(this,void 0,void 0,(function*(){const r=yield He.findById(e);t(null,r)}))))}(We()),Pt.use("/graphql",(0,vt.graphqlHTTP)({schema:mt,rootValue:{getProduct:wt.getProduct,getProducts:wt.getProducts,createProduct:wt.createProduct,updateProduct:wt.updateProduct,deleteProduct:wt.deleteProduct},graphiql:!0})),Pt.use("/",rt)})();